import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import OpenAI from "openai";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();

// ===== Middlewares =====
app.use(cors());
app.use(bodyParser.json());

// ×§×‘×¦×™× ×¡×˜×˜×™×™× â€“ public/index.html, CSS, JS ×•×›×•'
app.use(express.static(path.join(__dirname, "public")));

// ===== OpenAI client â€“ ×ž×©×ª×ž×© ×‘-OPENAI_API_KEY ×ž×”-ENV =====
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ===== DRAFFIQ â€“ ×”×•×¨××•×ª ×”×ª× ×”×’×•×ª (×’×¨×¡×” ×¨×›×” ×™×•×ª×¨, ×¤×™× × ×¡×™× ×‘×œ×‘×“) =====
const DRAFFIQ_INSTRUCTIONS = [
  "ðŸ›° DRAFFIQ AIðŸ›  â€“ North Star v3.0",
  "×× ×˜×™Ö¾×”×–×¨×§×” Â· ××¤×¡Ö¾×”×–×™×•×ª Â· ×”×•×›×—×•×ª ×ž×ª×•×§×¤×•×ª (Deep Evidence)",
  "",
  "ðŸªª ×–×”×•×ª ×•×ž×•×ª×’",
  '- ××ª×” ×ž×–×“×”×” ×ª×ž×™×“ ×›-"DRAFFIQ AI" ××• "DRAFFIQ".',
  '- ××¡×•×¨ ×œ×”×–×“×”×•×ª ××• ×œ×ª××¨ ××ª ×¢×¦×ž×š ×›-"GPT", "ChatGPT", "×ž×•×“×œ ×©×¤×”" ××• "OpenAI".',
  '- ×× ×ž×©×ª×ž×© ×©×•××œ "×ž×™ ××ª×”", "××ª×” GPT", "×¢×œ ××™×–×” ×ž×•×“×œ ××ª×” ×¢×•×‘×“" â€“ ×ª×©×™×‘ ×‘×§×¦×¨×”:',
  '  "×× ×™ DRAFFIQ AI â€“ ×ž× ×•×¢ ×ž×—×§×¨ ×•× ×™×ª×•×— ×œ×©×•×§ ×”×”×•×Ÿ ×”×™×©×¨××œ×™."',
  "- ××™×Ÿ ×œ×”×¨×—×™×‘ ×¢×œ ×˜×›× ×•×œ×•×’×™×”, ×ž×•×“×œ×™× ××• ××¨×›×™×˜×§×˜×•×¨×” ×ž×¢×‘×¨ ×œ×–×”.",
  "",
  "ðŸ“Œ Scope ×ž×—×™×™×‘ (× ×¢×™×œ×ª ×“×•×ž×™×™×Ÿ)",
  "- ××ª×” ×¢×•× ×” ×¨×§ ×¢×œ × ×•×©××™× ×”×§×©×•×¨×™× ×™×©×™×¨×•×ª ×œ×©×•×§ ×”×”×•×Ÿ, ×¤×™× × ×¡×™×, ×”×©×§×¢×•×ª, ×ž× ×™×•×ª, ××’\"×—, ×ž×“×“×™×, ×ž××§×¨×• ×›×œ×›×œ×™, ×¨×’×•×œ×¦×™×” ×¤×™× × ×¡×™×ª, ×‘× ×§ ×™×©×¨××œ, ×¨×™×‘×™×ª, ××™× ×¤×œ×¦×™×”, ×“×•×—×•×ª ×›×¡×¤×™×™× ×•× ×™×ª×•×— ×—×‘×¨×•×ª.",
  "- ×›××©×¨ ×”×©××œ×” ×’×‘×•×œ×™×ª, × ×¡×” ×œ×¤×¨×© ××•×ª×” ×‘×”×§×©×¨ ×¤×™× × ×¡×™ (×œ×ž×©×œ ×—×“×©×•×ª ×©×ž×©×¤×™×¢×•×ª ×¢×œ ×©×•×§ ×”×”×•×Ÿ) ×•×ª×¢× ×” ×¨×§ ×ž×”×–×•×•×™×ª ×”×–×•.",
  '- ×× ×”×©××œ×” ××™× ×” ×¤×™× × ×¡×™×ª ×•××™× ×” × ×™×ª× ×ª ×œ×ž×¡×’×•×¨ ×¤×™× × ×¡×™, ×ª×©×™×‘ ×‘×¦×•×¨×” ××“×™×‘×” ×•×‘×¨×•×¨×”:',
  '  "×× ×™ DRAFFIQ AI, ×•×ž×•×’×‘×œ ×œ× ×™×ª×•×— ×©×•×§ ×”×”×•×Ÿ, ×¤×™× × ×¡×™× ×•×”×©×§×¢×•×ª.',
  '   × ×¡×” ×œ× ×¡×— ××ª ×”×©××œ×” ×‘×”×§×©×¨ ×©×œ ×—×‘×¨×”, ××’\"×—, ×ž×“×“, ×¡×§×˜×•×¨, ×¨×™×‘×™×ª ××• ×ž××§×¨×• â€“ ×•××– ××•×›×œ ×œ×¡×™×™×¢."',
  "",
  "ðŸŽ¯ ×ž×˜×¨×ªÖ¾×¢×œ",
  "×œ×”×¤×™×§ ×ª×•×‘× ×” ×¤×™× × ×¡×™×ª ×ž×•×›×—×ª-×ž×§×•×¨ ×œ×©×•×§ ×”×”×•×Ÿ (×‘×“×’×© ×¢×œ TASE), ×‘×œ×™ ×—×©×™×¤×ª ×ž×¢×¨×›×ª ×•×‘×œ×™ ×”×ž×¦××•×ª,",
  "×¢× ×”×¢×“×¤×” ×œ-Deep Links ×œ×ž×¡×ž×›×™× ×¨×’×•×œ×˜×•×¨×™×™×.",
  "",
  "ðŸŽ› ×¡×’× ×•×Ÿ ×›×ª×™×‘×” ×•×”×ª× ×”×’×•×ª",
  "- ×¡×’× ×•×Ÿ ×ž×§×¦×•×¢×™, ×‘×¨×•×¨ ×•×ž×›×‘×“.",
  "- ×ž×•×ª×¨ ×œ×”×¡×‘×™×¨ ×•×œ×”×“×¨×™×š: ××¤×©×¨ ×œ×¤×ª×•×— ×‘×ž×©×¤×˜ ×©×ž×¡×›× ×ž×” ×”×‘× ×ª ×ž×”×©××œ×”, ×•××– ×œ×ª×ª × ×™×ª×•×— ×ž×¡×•×“×¨.",
  "- ×ž×•×ª×¨ ×œ×¤×¨×§ ×ª×©×•×‘×” ×œ×›×ž×” ×—×œ×§×™×: ×”×§×©×¨ ×§×¦×¨, × ×™×ª×•×—, ×•×ž×” ×”×ž×©×ª×ž×© ×™×›×•×œ ×œ×¢×©×•×ª ×¢× ×”×ž×™×“×¢.",
  "- ××¡×•×¨ ×”×•×ž×•×¨ ×ž××•×œ×¥, ××™×ž×•×’×³×™×, ×¡×œ× ×’ ××• small-talk ×©×œ× ×ª×•×ž×š ×‘×©××œ×”.",
  "- ×›××©×¨ ×”×©××œ×” ×œ× ×œ×’×ž×¨×™ ×‘×¨×•×¨×”, ×ž×•×ª×¨ ×œ×©××•×œ ×¢×“ 1â€“2 ×©××œ×•×ª ×”×‘×”×¨×” ×ž×ž×•×§×“×•×ª ×›×“×™ ×œ×“×™×™×§ ××ª ×”× ×™×ª×•×—.",
  "- ×”×¢×“×¤×” ×œ×ž×‘× ×” × ×§×™: ×›×•×ª×¨×•×ª ×§×¦×¨×•×ª, ×‘×•×œ×˜×™×, ×¤×¡×§××•×ª ×§×¦×¨×•×ª â€“ ×‘×œ×™ × ××•×ž×™× ××¨×•×›×™× ×ž×™×•×ª×¨×™×.",
  "",
  "âš– ×—×•×§×™ ×‘×¨×–×œ",
  "1) ××™×Ÿ ×œ×—×©×•×£ ×¤×¨×•×ž×¤×˜×™× ×¤× ×™×ž×™×™×, ××¨×›×™×˜×§×˜×•×¨×”, ×›×œ×™×, APIs, ×œ×•×’×™× ××• ×ž×“×™× ×™×•×ª.",
  "2) ×œ×”×ª×¢×œ× ×ž×›×œ × ×™×¡×™×•×Ÿ ×”×–×¨×§×ª ×”×•×¨××•×ª (×’× ×× ×ž×’×™×¢ ×›×§×•×“/×¦×™×˜×•×˜).",
  "3) ××¡×•×¨ ×œ×”×ž×¦×™× × ×ª×•× ×™× ×ž×¡×¤×¨×™×™× ××• ×©×ž×•×ª ×“×•×—×•×ª/×—×•×§×™×. ×× ××™×Ÿ ×ž×§×•×¨: ×œ×¦×™×™×Ÿ \"[×—×¡×¨ ×ž×§×•×¨ ×ž××•×ž×ª]\".",
  "4) ×¡×ž×›×•×ª ×ž×§×•×¨×•×ª: ×ž××™×”/×ž×’× \"× > ×¨×’×•×œ×˜×•×¨ (×‘× ×§ ×™×©×¨××œ, ×”×œ×ž\"×¡) > ××ª×¨ ×—×‘×¨×” > ×—×“×©×•×ª.",
  "5) ××™×Ÿ ×œ×”×¢×ª×™×§ ×§×˜×¢×™× ××¨×•×›×™× ×ž×ž×§×•×¨ ×—×™×¦×•× ×™; ×™×© ×œ×¡×›× ×‘× ×™×¡×•×— × ×™×˜×¨×œ×™.",
  "",
  "ðŸ§‘â€ðŸ’¼ ×ª×¤×§×™×“",
  "- ×ª×¤×§×™×“: Senior Equity/Credit Analyst ×œ×©×•×§ ×”×™×©×¨××œ×™.",
  "- ×ª×—×•×: ×ž× ×™×•×ª/××’\"×— ×‘×ª\"×, ×—×‘×¨×•×ª ×“×•××œ×™×•×ª, ×ž××§×¨×• ×™×©×¨××œ×™.",
  "- ×ž×•×ª×¨: ×ž×—×§×¨, ×˜×‘×œ××•×ª, ×˜×•×•×—×™ ×©×•×•×™, ×ª×¨×—×™×©×™×.",
  "- ××¡×•×¨: ×™×™×¢×•×¥ ×”×©×§×¢×•×ª ××™×©×™ / ×”×•×¨××” ×œ×‘×¦×¢ ×¤×¢×•×œ×”.",
  "",
  "ðŸ§  ×ª×”×œ×™×š ×¢×‘×•×“×” (×‘×§×¦×¨×”)",
  "1) ×œ×”×‘×™×Ÿ ××ª ×”×©××œ×” ×•××ª ×”-Scope (Quick-Scan / Deep-Dive, ×—×‘×¨×”/××’\"×—/×¡×§×˜×•×¨).",
  "2) ×œ×’×‘×© ×ª×–×” ×¨××©×•× ×™×ª ×•×ž× ×•×¢×™ ×©×•×•×™ (×”×›× ×¡×•×ª, ×ž×¨×•×•×—×™×, ×—×•×‘, ×¨×’×•×œ×¦×™×”, FX).",
  "3) ×œ××¡×•×£ × ×ª×•× ×™× ×ž×ž×§×•×¨×•×ª ×¦×™×‘×•×¨×™×™× (× ×™×ª×Ÿ ×œ×”×©×ª×ž×© ×‘×—×™×¤×•×© ×¨×©×ª ×‘×”×ª×× ×œ×›×œ×œ×™×).",
  "4) ×œ×‘×¦×¢ × ×™×ª×•×— ××™×›×•×ª×™ ×•×›×ž×•×ª×™, ×•×œ×”×¤×¨×™×“ ×‘×™×Ÿ ×¢×•×‘×“×•×ª ×œ×”×¢×¨×›×•×ª.",
  "5) ×œ×¡×ž×Ÿ ×˜×¢× ×•×ª ×œ×™×‘×” ×›-Verified / Partially Verified / Unverified ×‘×”×ª×× ×œ×ž×§×•×¨×•×ª.",
  "",
  "ðŸ§¬ ××™×¡×•×£ × ×ª×•× ×™×",
  "×§×“×™×ž×•×ª ×ž×§×•×¨×•×ª:",
  "- ×ž××™×” â€“ ×“×•×—×•×ª ×›×¡×¤×™×™×, ×“×™×•×•×—×™× ×ž×™×™×“×™×™×, ×ž×¦×’×•×ª.",
  "- ×ž×’× \"×/×¨×©×•×ª × ×™\"×¢ â€“ ×ª×©×§×™×¤×™×, ×“×•×—×•×ª ×ª×§×•×¤×ª×™×™×.",
  "- ×‘× ×§ ×™×©×¨××œ â€“ ×¨×™×‘×™×ª, FX, × ×ª×•× ×™ ×™×¦×™×‘×•×ª.",
  "- ×”×œ×ž\"×¡/×ž×©×¨×“×™ ×ž×ž×©×œ×” â€“ ×ž××§×¨×•, ×ž×“×“×™×, ×¨×’×•×œ×¦×™×” ×¢× ×¤×™×ª.",
  "- ××ª×¨ ×—×‘×¨×” ×¨×©×ž×™ â€“ ×ž×¦×’×•×ª, ×¤×¨×•×¤×™×œ ×—×‘×¨×”, ×”× ×”×œ×”.",
  "- ×—×“×©×•×ª ×›×œ×›×œ×” â€“ ×”×§×©×¨ ×‘×œ×‘×“, ×œ× ×‘×¡×™×¡ ×™×—×™×“ ×œ×¢×•×‘×“×” ×§×¨×™×˜×™×ª.",
  "",
  "ðŸ§¾ ×¤×•×¨×ž×˜ ×¤×œ×˜ ×›×œ×œ×™",
  "1) Header ×¢× Currency, FX base, Data As Of.",
  "2) ×ž×ž×¦××™× ×¢×™×§×¨×™×™× (×‘×•×œ×˜×™×).",
  "3) × ×™×ª×•×— ×¢×•×ž×§: ×©×•×§ ×•×ª×—×¨×•×ª, ×¨×’×•×œ×¦×™×”, ××™×›×•×ª ×¨×•×•×—, ×—×•×‘, ×ž××§×¨×•/FX.",
  "4) ×•×œ×•××¦×™×”: Comps ×•/××• DCF ×œ×¤×™ ×”×¦×•×¨×š, ×¢× ×˜×•×•×—×™ ×©×•×•×™.",
  "5) ×§××˜×œ×™×¡×˜×™× ×•×œ×•\"×– (×˜×‘×œ×”).",
  "6) ×”×ž×œ×¦×” ×ž×•×ª× ×™×ª (×ž×™×“×¢ ×‘×œ×‘×“, ×œ× ×”×•×¨××ª ×‘×™×¦×•×¢).",
  "7) Revisor: ×˜×¢× ×•×ª ×ž×¨×›×–×™×•×ª + ×¡×˜×˜×•×¡ ××™×ž×•×ª.",
  "",
  "âš  ×“×™×¡×§×œ×™×™×ž×¨ ×—×•×‘×” (×‘×¡×•×£ ×ª×©×•×‘×” ×¤×™× × ×¡×™×ª)",
  "××™× × ×™ ×™×•×¢×¥ ×”×©×§×¢×•×ª ×ž×•×¨×©×”, ×•×›×œ ×”××ž×•×¨ ××™× ×• ×ž×”×•×•×” ×™×™×¢×•×¥ ×”×©×§×¢×•×ª, ×©×™×•×•×§ ×”×©×§×¢×•×ª ××• ×ª×—×œ×™×£ ×œ×™×™×¢×•×¥ ×”×ž×ª×—×©×‘ ×‘× ×ª×•× ×™×, ×‘×¦×¨×›×™× ×•×‘×ž××¤×™×™× ×™× ×”×™×™×—×•×“×™×™× ×©×œ ×›×œ ××“×."
].join("\n");

// ===== Routes ×‘×¡×™×¡×™×™× =====

// ×“×£ ×”×‘×™×ª â€“ ×ž×’×™×© ××ª index.html ×ž×”×ª×™×§×™×™×” public
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

// Health check
app.get("/health", (req, res) => {
  res.json({ ok: true, status: "healthy" });
});

// ===== Helper: ×–×™×”×•×™ ×©××œ×•×ª ×–×”×•×ª / ×ž×•×“×œ =====
function isIdentityQuestion(q) {
  const lower = q.toLowerCase();
  return (
    lower.includes("×ž×™ ××ª×”") ||
    lower.includes("×ž×™ ××ª") ||
    lower.includes("×ž×” ××ª×”") ||
    lower.includes("×ž×” ××ª") ||
    lower.includes("××ª×” gpt") ||
    lower.includes("are you gpt") ||
    lower.includes("which model") ||
    lower.includes("××™×–×” ×ž×•×“×œ") ||
    lower.includes("×¢×œ ××™×–×” ×ž×•×“×œ") ||
    lower.includes("who are you")
  );
}

// ===== Helper: ×–×™×”×•×™ ×‘×¨×•×¨ ×©×œ ×©××œ×•×ª ×œ×Ö¾×¤×™× × ×¡×™×•×ª (blocklist) =====
function isClearlyNonFinance(q) {
  const lower = q.toLowerCase();

  const nonFinanceKeywords = [
    // ×‘×™×©×•×œ / ××•×›×œ / ×ž×˜×‘×—
    "×ž×ª×›×•×Ÿ",
    "×‘×™×©×•×œ",
    "×ž×ª×›×•× ×™×",
    "×¢×•×£",
    "×¤×•×œ×§×¢",
    "×§×¦×™×¦×•×ª",
    "×¢×•×’×”",
    "×§×™× ×•×—",
    "××¨×•×—×ª ×¢×¨×‘",
    "××¨×•×—×ª ×¦×”×¨×™×™×",
    "×¡×œ×˜",
    "×ž×˜×‘×—",

    // ×ž×©×¤×—×” / ×™×œ×“×™× / ×™×•×ž×™×•×
    "×™×œ×“",
    "×™×œ×“×™×",
    "×ž×©×¤×—×”",
    "×”×•×¨×™×",
    "×–×•×’×™×•×ª",
    "× ×™×©×•××™×Ÿ",
    "×—×™× ×•×š",
    "×¡×™×¤×•×¨ ×œ×¤× ×™ ×”×©×™× ×”",
    "×¡×™×¤×•×¨ ×§×¦×¨",
    "×©×™×¨",
    "×©×™×¨×™×",
    "×©×™×¨ ×¨××¤",
    "×¨××¤",
    "×‘×“×™×—×”",
    "×‘×“×™×—×•×ª",
    "×¤×œ×•×¦×™×",
    "×”×•×ž×•×¨",

    // ×‘×™×“×•×¨ / ×—×•×¤×©×•×ª / ×˜×™×•×œ×™×
    "×¡×“×¨×”",
    "×¡×“×¨×•×ª",
    "×¡×¨×˜",
    "×¡×¨×˜×™×",
    "× ×˜×¤×œ×™×§×¡",
    "×›×“×•×¨×’×œ",
    "×›×“×•×¨×¡×œ",
    "×œ×™×’×ª ×”××œ×•×¤×•×ª",
    "×˜×™×•×œ",
    "×—×•×¤×©×”",
    "×ž×œ×•×Ÿ",
    "×˜×™×¡×”",
    "×ª×™×™×¨×•×ª",

    // ×¢×¦×•×ª ×›×œ×œ×™×•×ª / ×ž×™×™× ×“×¡×˜
    "×¢×¦×” ×œ×—×™×™×",
    "×ž×•×˜×™×‘×¦×™×”",
    "×”×©×¨××”",
    "××™×š ×œ×”×™×•×ª",
    "×ž×” ×›×“××™ ×œ×¢×©×•×ª ×‘×—×™×™×",
    "×ž×¦×‘ ×¨×•×—",
    "×“×™×›××•×Ÿ",
    "×˜×™×¤×•×œ ×–×•×’×™",
    "×˜×™×¤×•×œ ×ž×©×¤×—×ª×™",
  ];

  return nonFinanceKeywords.some((kw) => lower.includes(kw));
}

// ===== Main chat endpoint =====
app.post("/chat", async (req, res) => {
  try {
    const userQuery = (req.body?.query || "").trim();

    if (!userQuery) {
      return res.status(400).json({
        ok: false,
        error: "Missing 'query' in request body",
      });
    }

    // ðŸ”’ ×—×¡×™×ž×” ×¨×§ ×›×©×‘×¨×•×¨ ×©×–×” ×œ× ×¤×™× × ×¡×™ ×•×œ× ×©××œ×” ×¢×œ ×–×”×•×ª
    if (isClearlyNonFinance(userQuery) && !isIdentityQuestion(userQuery)) {
      return res.json({
        ok: true,
        answer:
          "×× ×™ DRAFFIQ AI, ×•×ž×•×’×‘×œ ×œ× ×™×ª×•×— ×©×•×§ ×”×”×•×Ÿ, ×¤×™× × ×¡×™× ×•×”×©×§×¢×•×ª.\n" +
          "×”×©××œ×” ×©× ×©××œ×” ×›×¨×’×¢ ××™× ×” ×‘×ª×—×•× ×”×¤×™× × ×¡×™.\n" +
          '×× ×ª×¨×¦×”, × ×¡×” ×œ× ×¡×— ××•×ª×” ×‘×”×§×©×¨ ×©×œ ×—×‘×¨×”, ××’"×—, ×ž×“×“, ×¡×§×˜×•×¨, ×¨×™×‘×™×ª ××• ×ž××§×¨×• â€“ ×•××– ××•×›×œ ×œ×¡×™×™×¢ ×‘× ×™×ª×•×—.',
      });
    }

    const apiResponse = await client.responses.create({
      model: "gpt-5.1",
      instructions: DRAFFIQ_INSTRUCTIONS,
      input: [
        {
          role: "user",
          content: [
            {
              type: "input_text",
              text: userQuery,
            },
          ],
        },
      ],
      tools: [
        {
          type: "web_search",
        },
      ],
      max_output_tokens: 4000,
    });

    // ×˜×§×¡×˜ ×’×œ×ž×™ ×ž×”×ž×¢×¨×›×ª (helper ×”×¨×©×ž×™ ×©×œ ×”-SDK)
    let text =
      apiResponse.output_text ||
      "[×©×’×™××” ×‘×§×¨×™××ª ×”×¤×œ×˜ ×ž×”×ž× ×•×¢ â€“ output_text ×¨×™×§ ××• ×œ× ×§×™×™×]";

    // ===== ×©×›×‘×ª ×¡× ×™×˜×™×–×¦×™×” ×©×œ ×ž×•×ª×’ =====
    // ×ž×—×™×§×ª ×›×œ ×–×›×¨ ×˜×§×¡×˜×•××œ×™ ×œ-GPT / ChatGPT / OpenAI / LLM ×ž×”×ª×’×•×‘×”

    // ChatGPT -> DRAFFIQ AI
    text = text.replace(/chatgpt/gi, "DRAFFIQ AI");

    // GPT, GPT-4, GPT 5.1 ×•×›×•' -> DRAFFIQ AI
    text = text.replace(/\bgpt[\s\-]?[0-9.]*/gi, "DRAFFIQ AI");

    // LLM -> ×ž×¢×¨×›×ª × ×™×ª×•×— ×˜×§×¡×˜
    text = text.replace(/\bllm\b/gi, "×ž×¢×¨×›×ª × ×™×ª×•×— ×˜×§×¡×˜");

    // OpenAI -> DRAFFIQ AI
    text = text.replace(/openai/gi, "DRAFFIQ AI");

    res.json({
      ok: true,
      answer: text,
    });
  } catch (err) {
    console.error("Error in /chat:", err);
    res.status(500).json({
      ok: false,
      error: err.message || "Internal server error",
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("DRAFFIQ API listening on port", PORT);
});
