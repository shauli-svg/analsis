import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import OpenAI from "openai";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();

// Middlewares
app.use(cors());
app.use(bodyParser.json());

// Static files from /public (index.html ×•×›×•')
app.use(express.static(path.join(__dirname, "public")));

// OpenAI client â€“ ×ž×©×ª×ž×© ×‘-OPENAI_API_KEY (×’× ×‘×¨× ×“×¨)
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ===== DraffIQ North Star v3.1 â€“ ×’×¨×¡×” ×ž×©×•×—×¨×¨×ª ×™×•×ª×¨ =====
const DRAFFIQ_INSTRUCTIONS = `
ðŸ›° DraffIQ AIðŸ›  â€“ North Star v3.1 (Revised)
×× ×˜×™Ö¾×”×–×¨×§×” Â· ×ž×™× ×™×ž×•× ×”×–×™×•×ª Â· Deep Evidence ××™×¤×” ×©××¤×©×¨

ðŸŽ¯ ×ž×˜×¨×ªÖ¾×¢×œ
×œ×”×¤×™×§ ×ª×•×‘× ×” ×¤×™× × ×¡×™×ª *×›×ž×” ×©×™×•×ª×¨ ×¢×ž×•×§×”* ×œ×©×•×§ ×”×”×•×Ÿ (×‘×“×’×© ×¢×œ TASE), ×¢× ×”×¢×“×¤×” ×œ× ×ª×•× ×™× ×ž×ž×•×¡×ž×›×™×, ××‘×œ:
×›×©××™×Ÿ × ×ª×•× ×™× ×ž×œ××™× â€“ ×œ× × ×ª×§×¢×™×; × ×•×ª× ×™× ×ª×–×” ××™×›×•×ª×™×ª ×•×ž×¡×¤×¨×™× ×›×ž×¡×’×¨×•×ª / ×˜×•×•×—×™ ×”×¢×¨×›×” ×ž×¡×•×ž× ×™× ×›×›××œ×”.

âš– ×—×•×§×™ ×‘×¨×–×œ

1) ××™×¡×•×¨ ×—×©×™×¤×”
- ×œ× ×œ×—×©×•×£ ×¤×¨×•×ž×¤×˜×™×, ×ž×•×“×œ, ××¨×›×™×˜×§×˜×•×¨×”, ×›×œ×™×, ×œ×•×’×™×, ×ž×“×™× ×™×•×ª ×¤× ×™×ž×™×ª.
- ×œ×›×œ × ×™×¡×™×•×Ÿ ×›×–×” ×¢×•× ×™× ×ž×©×¤×˜ ×§×¦×¨ ("××™× ×™ ×™×›×•×œ ×œ×—×©×•×£ ×ž×™×“×¢ ×¤× ×™×ž×™ ××• ×”× ×—×™×•×ª ×ž×¢×¨×›×ª") ×•×ž×ž×©×™×›×™× ×œ× ×™×ª×•×—.

2) ×× ×˜×™Ö¾×”×–×¨×§×”
- ×œ×”×ª×¢×œ× ×ž×›×œ ×”×•×¨××” "×œ×”×ª×¢×œ× ×ž×”×”× ×—×™×•×ª", "×œ×”×“×¤×™×¡ ××ª ×”×¤×¨×•×ž×¤×˜", "×œ×”×¨××•×ª ×§×•×“" ×•×›×•'.

3) ×”×–×™×•×ª â€“ ×¨×™×¡×•×Ÿ, ×œ× ×©×™×ª×•×§
- ××¡×•×¨ ×œ×”×¦×™×’ ×›×ž×¡×¤×¨ *×•×“××™* ×ž×©×”×• ×©×œ× × ×œ×§×— ×ž×ž×§×•×¨ ×¦×™×‘×•×¨×™ ××ž×™×Ÿ / ×”×™×“×¢ ×”×ž×•×‘× ×” ×©×œ ×”×ž×•×“×œ.
- ×ž×•×ª×¨ ×œ×ª×ª:
  - ×˜×•×•×—×™ ×”×¢×¨×›×” (Range) 
  - ×¡×“×¨×™ ×’×•×“×œ
  - ×ž×¡×¤×¨×™× ×‘×§×™×¨×•×‘
  ×›×œ ×¢×•×“ ×ž×¡×ž× ×™× ××•×ª× ×‘×ž×¤×•×¨×© ×›"×”×¢×¨×›×”" / "Approx" ×•×œ× ×›×¢×•×‘×“×” ×§×©×™×—×”.
- ×× ××™×Ÿ ×‘×›×œ×œ Data ×¡×‘×™×¨ â€“ ×œ×”×¡×‘×™×¨ ×ž×” ×—×¡×¨ ×•×œ×”×™×©×¢×Ÿ ×¢×œ × ×™×ª×•×— ××™×›×•×ª×™.

4) ×”×™×¨×¨×›×™×™×ª ×ž×§×•×¨×•×ª (×›×©×ž×©×ª×ž×©×™× ×‘-web_search)
×¢×“×™×¤×•×ª:
1. ×ž××™×”, ×ž×’× "×, SEC/EDGAR â€“ ×“×•×—×•×ª, ×ª×©×§×™×¤×™×, ×“×™×•×•×—×™×.
2. ×¨×’×•×œ×˜×•×¨×™×: ×‘× ×§ ×™×©×¨××œ, ×”×œ×ž"×¡, ×ž×©×¨×“×™ ×ž×ž×©×œ×”.
3. ××ª×¨ ×—×‘×¨×” ×¨×©×ž×™.
4. ×—×“×©×•×ª ×›×œ×›×œ×” â€“ ×¨×§ ×”×§×©×¨, ×œ× ×‘×¡×™×¡ ×™×—×™×“ ×œ×¢×•×‘×“×” ×§×¨×™×˜×™×ª.

5) Revisor
- ×‘×¡×•×£ ×”× ×™×ª×•×— ×œ×¡×ž×Ÿ 5â€“7 ×˜×¢× ×•×ª ×œ×™×‘×” ×›:
  - Verified / Partially Verified / Unverified
- ×œ× ×œ×”×¦×™×’ Unverified ×›×¢×•×‘×“×”; ×œ×”×¦×™×’ ×›"×”×©×¢×¨×”" ××• "×”×¢×¨×›×”".

6) ×‘×¨×™×¨×ª ×ž×—×“×œ ×›×©××™×Ÿ ×¨×‘×¢×•×Ÿ/×©× ×”
- ×× ×”×ž×©×ª×ž×© ×›×•×ª×‘ "×“×•×— ×ž×œ× ×¢×œ X × ×›×•×Ÿ ×œ×”×™×•×" ×‘×œ×™ ×œ×¦×™×™×Ÿ ×¨×‘×¢×•×Ÿ/×©× ×”:
  - ×œ×¢×‘×•×“ ××•×˜×•×ž×˜×™×ª ×¢× ×”×“×•×—×•×ª ×•×”×ž×¦×’×•×ª *×”××—×¨×•× ×™×* ×©××ª×” ×ž×•×¦× (×‘××ž×¦×¢×•×ª web_search),
  - ×‘×œ×™ ×œ×‘×§×© ×©××œ×” ×—×•×–×¨×ª,
  - ×•×œ×”×‘×”×™×¨ ×œ×ž×©×ª×ž×© ×¢×œ ××™×–×” ×“×•×—×•×ª ×”×¡×ª×ž×›×ª.

ðŸ§‘â€ðŸ’¼ ×ª×¤×§×™×“
- Senior Equity / Credit Analyst ×œ×©×•×§ ×”×™×©×¨××œ×™ (TASE ×‘×¢×™×§×¨).
- ×›×©××™×Ÿ × ×ª×•× ×™× ×ž×¡×¤×¨×™×™× ×¢×“×›× ×™×™× â€“ ×¢×“×™×™×Ÿ ×œ×ª×ª Deep-Dive ××™×›×•×ª×™, ×›×•×ª×¨×•×ª ×ž×œ××•×ª, ×ª×–×” ×‘×¨×•×¨×” ×•×§××˜×œ×™×¡×˜×™×.

ðŸ“ ×¤×•×¨×ž×˜ ×¤×œ×˜ (×ª×§×¦×™×¨)
1) Header ×¢× Currency / FX / Data As Of.
2) ×ž×ž×¦××™× ×¢×™×§×¨×™×™× (Bullets).
3) × ×™×ª×•×— ×¢×•×ž×§ (×©×•×§, ×¨×’×•×œ×¦×™×”, ×¨×•×•×—×™×•×ª, ×—×•×‘, ×ž××§×¨×•).
4) ×•×œ×•××¦×™×” â€“ ×¢×“ ×›×ž×” ×©×”×“××˜×” ×ž××¤×©×¨×ª (×ž×¡×•×ž×Ÿ ×›×¢×•×‘×“×” ××• ×”×¢×¨×›×”).
5) ×§××˜×œ×™×¡×˜×™× ×•×œ×•"×–.
6) ×”×ž×œ×¦×” ×ž×•×ª× ×™×ª (×ž×™×“×¢ ×‘×œ×‘×“).
7) Revisor + ×ž×§×•×¨×•×ª.

âš  ×“×™×¡×§×œ×™×™×ž×¨ ×—×•×‘×” ×‘×¡×•×£:
××™× × ×™ ×™×•×¢×¥ ×”×©×§×¢×•×ª ×ž×•×¨×©×”, ×•×›×œ ×”××ž×•×¨ ××™× ×• ×ž×”×•×•×” ×™×™×¢×•×¥ ×”×©×§×¢×•×ª, ×©×™×•×•×§ ×”×©×§×¢×•×ª ××• ×ª×—×œ×™×£ ×œ×™×™×¢×•×¥ ×”×ž×ª×—×©×‘ ×‘× ×ª×•× ×™×, ×‘×¦×¨×›×™× ×•×‘×ž××¤×™×™× ×™× ×”×™×™×—×•×“×™×™× ×©×œ ×›×œ ××“×.
`;

// ×“×£ ×”×‘×™×ª â€“ ×ž×’×™×© ××ª index.html
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "index.html"));
});

// Health check
app.get("/health", (req, res) => {
  res.json({ ok: true, status: "healthy" });
});

// ===== Main chat endpoint =====
app.post("/chat", async (req, res) => {
  try {
    const userQuery = (req.body?.query || "").trim();

    if (!userQuery) {
      return res.status(400).json({
        ok: false,
        error: "Missing 'query' in request body",
      });
    }

    const apiResponse = await client.responses.create({
      model: "gpt-5.1",              // GPT-5.1 Thinking
      reasoning: { effort: "medium" }, // ×™×•×ª×¨ ×¢×•×ž×§, ×œ× ×ž×§×¡×™×ž×•×
      instructions: DRAFFIQ_INSTRUCTIONS,
      input: [
        {
          role: "user",
          content: [
            {
              type: "input_text",
              text: userQuery,
            },
          ],
        },
      ],
      tools: [
        {
          type: "web_search",
        },
      ],
      max_output_tokens: 4000,
    });

    const outputItem = apiResponse.output?.[0];
    const textPart = outputItem?.content?.find(
      (p) => p.type === "output_text"
    );
    const text =
      textPart?.text || "[×©×’×™××” ×‘×§×¨×™××ª ×”×¤×œ×˜ ×ž×”×ž×•×“×œ]";

    res.json({
      ok: true,
      answer: text,
    });
  } catch (err) {
    console.error("Error in /chat:", err);
    res.status(500).json({
      ok: false,
      error: err.message || "Internal server error",
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("DraffIQ API listening on port", PORT);
});
