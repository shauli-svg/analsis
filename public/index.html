<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>DRAFFIQ AI â€“ TASE Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <style>
    :root {
  color-scheme: light;

  /* ×¨×§×¢ ×›×œ×œ×™ ×‘×”×™×¨ ×™×•×ª×¨ */
  --bg-page: #f5f6f8;
  --bg-card: #fcfcfd;
  --bg-messages: #f7f8fa;

  /* ×‘×•×¢×•×ª ××©×ª××©/××•×“×œ ×‘×”×™×¨×•×ª */
  --bg-user: #ffffff;
  --bg-assistant: #f3f4f8;

  --border-subtle: rgba(148, 163, 184, 0.25);
  --border-soft: rgba(148, 163, 184, 0.18);

  --text-main: #111827;
  --text-muted: #6b7280;

  --accent-soft: #e2e4ea;

  --radius-xl: 22px;
  --radius-lg: 18px;
  --radius-md: 12px;

  --shadow-soft: 0 14px 38px rgba(15, 23, 42, 0.10);
  --vh: 1vh;
}

html,
body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  /* ××¢×‘×¨ ×˜×•× ×™× ××•×“×¨× ×™ ×•×¢×“×™×Ÿ ×™×•×ª×¨ */
  background:
    radial-gradient(circle at top, #ffffff 0, #f3f4f7 38%, #e2e4ea 100%);
  color: var(--text-main);
  min-height: calc(var(--vh, 1vh) * 100);
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

    /* ===== Landing overlay / ×“×£ ×›× ×™×¡×” ===== */
    .landing-overlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      opacity: 1;
      transition: opacity 0.4s ease;
    }

    .landing-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .landing-content {
      position: relative;
      z-index: 2;
      text-align: center;
      color: #111827;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .landing-logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    .landing-icon {
      width: 76px;
      height: 76px;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.8),
        0 8px 20px rgba(15, 23, 42, 0.15);
      animation: iconBounce 0.7s ease-out 1.3s 1;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 20%, #9ca3af 100%);
    }

    .landing-title {
      font-weight: 800;
      font-size: 2.1rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #111827;
    }

    .landing-subtitle {
      font-size: 0.95rem;
      color: #4b5563;
      letter-spacing: 0.03em;
      margin-top: 4px;
    }

    .landing-cta-wrap {
      margin-top: 8px;
    }

    .landing-cta {
      border-radius: 999px;
      border: 1px solid #111827;
      background: transparent;
      color: #111827;
      padding: 6px 18px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      text-decoration: none;
      transition:
        background-color 0.15s ease,
        color 0.15s ease,
        transform 0.08s ease,
        box-shadow 0.15s ease;
    }

    .landing-cta span.arrow {
      font-size: 0.9rem;
      line-height: 1;
    }

    .landing-cta:hover {
      background: #e5e7eb; /* ××¤×•×¨ ×‘×”×™×¨ ×™×•×ª×¨ */
      color: #111827; /* ×”×›×ª×‘ × ×©××¨ ×©×—×•×¨ */
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.18);
    }

    .landing-curtain {
      position: absolute;
      inset: 0;
      background: #ffffff;
      z-index: 3;
      transform-origin: left center;
      animation: curtainOpen 2.6s ease-out forwards;
    }

    @keyframes curtainOpen {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(100%);
      }
    }

    @keyframes iconBounce {
      0% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      70% {
        transform: translateY(4px);
      }

      100% {
        transform: translateY(0);
      }
    }

    /* Top bar */
    .top-bar {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom,
          rgba(249, 250, 251, 0.92),
          rgba(249, 250, 251, 0.86));
      border-bottom: 1px solid rgba(209, 213, 219, 0.9);
    }

    .top-bar-inner {
      width: 100%;
      max-width: 960px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      position: relative;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
    }

    .brand-icon {
      width: 23px;
      height: 23px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 20%, #9ca3af 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
      color: #F5F5F5;
      text-transform: uppercase;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.6),
        0 4px 8px rgba(148, 163, 184, 0.4);
    }

    .brand-title {
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    .brand-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .top-right {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .top-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .menu-btn {
      border: none;
      background: transparent;
      border-radius: 0;
      padding: 4px 6px;
      font-size: 1.1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition:
        transform 0.08s ease;
      box-shadow: none;
    }

    .menu-btn:hover {
      transform: translateY(-0.5px);
    }

    .top-new-btn {
      padding: 4px 12px;
      font-size: 0.78rem;
      background: #111827;
      color: #f9fafb;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.9);
    }

    .top-new-btn:hover:not(:disabled) {
      background: #020617;
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.45);
      transform: translateY(-0.5px);
    }

    /* ×ª×¤×¨×™×˜ × ×™×•×•×˜ */
    .menu-dropdown {
      position: absolute;
      top: 44px;
      inset-inline-end: 0;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
      padding: 6px;
      min-width: 160px;
      display: none;
      z-index: 20;
    }

    .menu-dropdown.open {
      display: block;
    }

    .menu-item-btn {
      width: 100%;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: #ffffff;
      color: #111827;
      border-radius: 8px;
      justify-content: flex-start;
    }

    .menu-item-btn:hover {
      background: #f3f4f6;
      box-shadow: none;
      transform: none;
    }

    /* Main layout */
    .app-shell {
  flex: 1;
  display: flex;
  justify-content: center;
  /* ×§×¦×ª ××¨×•×•×— ××”×§×¦×•×•×ª ××‘×œ ×¨×—×‘ */
  padding: 16px 24px 20px;
  min-height: 0;
}

.chat-wrapper {
  width: 100%;
  /* ×‘××§×•× 960px â€“ ×›××¢×˜ ×›×œ ×”××¡×š */
  max-width: 1320px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

    .chat-layout {
      display: flex;
      gap: 12px;
      align-items: stretch;
      min-height: 0;
    }

    /* Sidebar â€“ ×¨×©×™××ª ×©×™×—×•×ª */
    .sidebar {
      width: 220px;
      background: #f9fafb;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .sidebar-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .sidebar-new-btn {
      padding: 3px 8px;
      font-size: 0.75rem;
      background: #e5e7eb;
      border-radius: 999px;
    }

    .sidebar-new-btn:hover {
      background: #d4d4d4;
      box-shadow: none;
      transform: translateY(-0.5px);
    }

    .session-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.7) transparent;
      padding-inline: 2px;
    }

    .session-list::-webkit-scrollbar {
      width: 6px;
    }

    .session-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .session-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .session-item {
      width: 100%;
      text-align: right;
      justify-content: flex-start;
      padding: 6px 8px;
      font-size: 0.78rem;
      background: #f9fafb;
      color: #111827;
      border-radius: 10px;
      border: 1px solid transparent;
    }

    .session-item:hover {
      background: #e5e7eb;
      box-shadow: none;
      transform: none;
    }

    .session-item.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .panel {
  flex: 1;
  min-height: 0;
  background: var(--bg-card);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-soft);
  border: 1px solid var(--border-subtle);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ××–×•×¨ ×”×”×•×“×¢×•×ª */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 18px 20px;
  background: var(--bg-messages);
  border-bottom: 1px solid rgba(209, 213, 219, 0.7);
  scrollbar-width: thin;
  scrollbar-color: rgba(148, 163, 184, 0.6) transparent;
  -webkit-overflow-scrolling: touch;
  margin: 12px 14px 0;
  border-radius: var(--radius-lg);
}

/* ×‘×•×¢×•×ª */
.message-row.user {
  background: var(--bg-user);
  border: 1px solid rgba(209, 213, 219, 0.6);
}

.message-row.assistant {
  background: var(--bg-assistant);
  border: 1px solid rgba(209, 213, 219, 0.55);
}

    .message-avatar {
      flex: 0 0 30px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 2px;
    }

    .avatar-circle {
      width: 25px;
      height: 25px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.5rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: #e5e7eb;
      color: #111827;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .avatar-user {
      background: #ffffff;
    }

    .avatar-assistant {
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 20%, #9ca3af 100%);
      color: transparent;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.6),
        0 4px 8px rgba(148, 163, 184, 0.4);
    }

    .message-content {
      flex: 1;
      min-width: 0;
      font-size: 0.9rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-main);
    }

    .message-content a {
      color: #111827;
      text-decoration: none;
    }

    .inline-link {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #f9fafb;
      font-size: 0.75rem;
      gap: 4px;
    }

    .message-meta {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .message.system {
      margin: 6px 0 14px;
      padding: 10px 12px;
      border-radius: var(--radius-lg);
      background: #f9fafb;
      font-size: 0.8rem;
      text-align: center;
      border: 1px dashed rgba(148, 163, 184, 0.9);
      color: var(--text-main);
    }

    .system-line-sub {
      font-size: 0.8rem;
      color: var(--text-main);
    }

    /* Input panel */
    .input-shell {
  padding: 10px 20px 14px;
  background: #f8fafc;
}

.input-inner {
  border-radius: 999px;
  background: #f4f5f9;
  border: 1px solid var(--border-soft);
  padding: 4px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
  width: 100%;
  margin: 0;
}

.input-inner:focus-within {
  border-color: rgba(107, 114, 128, 0.9);
  background: #ffffff;
  box-shadow:
    0 0 0 1px rgba(156, 163, 175, 0.6),
    0 10px 22px rgba(148, 163, 184, 0.28);
}

    .input-textarea-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    textarea {
      resize: none;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-family: inherit;
      font-size: 0.9rem;
      height: 44px;
      min-height: 44px;
      max-height: 44px;
      overflow-y: auto;
      padding: 4px 8px 4px 0;
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition:
        background-color 0.15s ease,
        transform 0.08s ease,
        box-shadow 0.15s ease;
    }

    button span.icon {
      font-size: 1rem;
    }

    button:hover:not(:disabled) {
      background: #d4d4d4;
      transform: translateY(-0.5px);
      box-shadow: 0 3px 8px rgba(107, 114, 128, 0.3);
    }

    button:disabled {
      opacity: 0.65;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    /* ×©×•×¨×ª ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” â€“ ×™×™×©×•×¨ ×œ×™××™×Ÿ */
    .actions-row {
  margin-top: 6px;
  font-size: 0.75rem;
  display: flex;
  /* ×©×•×¨×” ×‘Ö¾LTR ×›×“×™ ×©-flex-end ×™×”×™×” ×™××™×Ÿ */
  direction: ltr;
  justify-content: flex-end;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
  width: 100%;
  margin: 6px 0 0;
  padding: 0 18px;
}

.actions-row button {
  padding: 4px 10px;
  font-size: 0.75rem;
  background: #edf0f4;
}

    /* ×©×•×¨×ª ××¦×‘ â€“ ×œ××˜×” */
    .status-line {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: flex-start;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      max-width: 720px;
      margin: 6px auto 0;
    }

    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #9ca3af;
      box-shadow: 0 0 0 3px rgba(229, 231, 235, 1);
    }

    /* ×›×¤×ª×•×¨×™ ×“×•×’×××•×ª ×œ×¤×¨×•××¤×˜×™× */
    .prompt-examples {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      max-width: 720px;
      margin-inline: auto;
    }

    .examples-label {
      font-weight: 500;
      color: var(--text-muted);
      margin-inline-start: 4px;
    }

    .example-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 10px;
      font-size: 0.75rem;
      background: #f9fafb;
      cursor: pointer;
    }

    .example-btn:hover {
      background: #e5e7eb;
    }

    /* ××¦×‘ ×¢×‘×•×“×” â€“ Quick / Deep */
    .mode-toggle {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      max-width: 720px;
      margin-inline: auto;
    }

    .mode-label {
      font-weight: 500;
      color: var(--text-muted);
      margin-inline-start: 2px;
    }

    .mode-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 10px;
      font-size: 0.75rem;
      background: #f3f4f6;
      cursor: pointer;
    }

    .mode-btn.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    /* Thinking dots */
    .thinking-dots {
      display: inline-flex;
      gap: 3px;
      align-items: center;
      margin-top: 2px;
    }

    .thinking-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #9ca3af;
      opacity: 0.4;
      animation: pulse 1s infinite ease-in-out;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    .thinking-dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: translateY(0);
        opacity: 0.4;
      }

      50% {
        transform: translateY(-2px);
        opacity: 1;
      }
    }

    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }

      .chat-layout {
        flex-direction: column;
      }
    }

    @media (max-width: 720px) {
      .top-bar-inner {
        padding: 0 12px;
      }

      .app-shell {
        padding: 8px 10px 8px;
      }

      .panel {
        border-radius: 18px;
      }

      .top-status {
        display: none;
      }

      textarea,
      button {
        font-size: 1rem;
      }

      .input-inner,
      .actions-row,
      .status-line,
      .mode-toggle,
      .prompt-examples {
        max-width: 100%;
      }
    }

    /* ===== ×”×“×¤×¡×” × ×§×™×™×” ===== */
    @media print {

      .landing-overlay,
      .top-bar,
      .input-shell,
      .sidebar {
        display: none !important;
      }

      body {
        background: #ffffff !important;
      }

      .app-shell {
        padding: 0;
      }

      .panel {
        box-shadow: none;
        border: none;
        border-radius: 0;
      }

      #messages {
        border: none;
        background: #ffffff;
      }
    }
  </style>
</head>

<body>
  <!-- ×“×£ ×›× ×™×¡×” / ×¤×ª×™×—×ª ×•×™×œ×•×Ÿ -->
  <div id="landing-overlay" class="landing-overlay">
    <div class="landing-content">
      <div class="landing-logo">
        <div class="brand-icon landing-icon"></div>
        <div class="landing-title">DRAFFIQ AI</div>
        <div class="landing-subtitle">×™×—×™×“×ª ××•×“×™×¢×™×Ÿ ×¢×¡×§×™×ª ×œ×©×•×§ ×”×”×•×Ÿ ×”×™×©×¨××œ×™</div>
      </div>
      <div class="landing-cta-wrap">
        <button type="button" id="landing-cta" class="landing-cta">
          <span>×™×—×™×“×ª ××•×“×™×¢×™×Ÿ ×¢×¡×§×™×ª</span>
          <span class="arrow">â†</span>
        </button>
      </div>
    </div>
    <div class="landing-curtain"></div>
  </div>

  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="brand">
        <div class="brand-icon"></div>
        <div>
          <div class="brand-title">DRAFFIQ AI</div>
          <div class="brand-subtitle">××—×§×¨ ×•× ×™×ª×•×— ×œ×©×•×§ ×”×”×•×Ÿ ×”×™×©×¨××œ×™</div>
        </div>
      </div>
      <div class="top-right">
        <div class="top-status">
          ENGINE: DRAFFIQ Â· SCOPE: TASE Â· FINANCE ONLY
        </div>
        <button type="button" id="new-btn" class="top-new-btn">×©×™×—×” ×—×“×©×”</button>
        <button type="button" class="menu-btn" id="menu-btn">â˜°</button>

        <!-- ×ª×¤×¨×™×˜ × ×™×•×•×˜ -->
        <div id="menu-dropdown" class="menu-dropdown">
          <button type="button" class="menu-item-btn" id="home-link">×“×£ ×”×‘×™×ª</button>
          <button type="button" class="menu-item-btn" id="chat-link">×¦×³××˜ TASE</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app-shell">
    <div class="chat-wrapper">
      <div class="chat-layout">
        <!-- ×¡×¨×’×œ ×©×™×—×•×ª -->
        <aside class="sidebar" id="session-sidebar">
          <div class="sidebar-header">
            <div class="sidebar-title">×©×™×—×•×ª</div>
            <button type="button" id="sidebar-new-btn" class="sidebar-new-btn">+ ×—×“×©×”</button>
          </div>
          <div class="session-list" id="session-list"></div>
        </aside>

        <!-- ××™×–×•×¨ ×”×¦×³××˜ -->
        <div class="panel" id="chat-section">
          <div id="messages">
            <div class="message system">
              <div class="system-line-sub">
                ×›×ª×•×‘ ×¤×¨×•××¤×˜ ××œ× ×›×¤×™ ×©×”×™×™×ª ××’×“×™×¨ ×œ×× ×œ×™×¡×˜ ×‘×›×™×¨, ×›×•×œ×œ ××¦×‘ ×¢×‘×•×“×” (Quick-Scan / Deep-Dive),
                × ×›×¡ (×× ×™×”/××’×´×—/×¡×§×˜×•×¨) ×•×“×’×©×™× ×¢×™×§×¨×™×™×.
              </div>
            </div>
          </div>

          <div class="input-shell">
            <form id="chat-form">
              <div class="input-inner">
                <div class="input-textarea-wrap">
                  <textarea id="query" name="query" rows="3"></textarea>
                </div>
                <button type="submit" id="send-btn">
                  <span class="icon">â¤</span>
                  <span class="label">×©×œ×—</span>
                </button>
              </div>

              <div class="actions-row">
                <button type="button" id="print-btn">×”×“×¤×¡ / PDF</button>
                <button type="button" id="share-btn">×©×™×ª×•×£</button>
              </div>

              <div class="mode-toggle">
                <span class="mode-label">××¦×‘ ×¢×‘×•×“×”:</span>
                <button type="button" class="mode-btn active" data-mode="quick">
                  Quick-Scan
                </button>
                <button type="button" class="mode-btn" data-mode="deep">
                  Deep-Dive
                </button>
              </div>

              <!-- ×›××Ÿ ×™×™×›× ×¡×• ×›×¤×ª×•×¨×™ ×”×“×•×’×××•×ª -->
              <div id="promptExamplesContainer"></div>

              <div class="status-line">
                <div class="status-pill">
                  <span class="status-dot"></span>
                  <span>××¦×‘: ××—×§×¨ ×¤×™× × ×¡×™ ×‘×œ×‘×“ Â· ×œ× ×™×™×¢×•×¥ ×”×©×§×¢×•×ª</span>
                </div>
              </div>
            </form>
          </div>
        </div> <!-- /panel -->
      </div> <!-- /chat-layout -->
    </div>
  </div>

  <script>
  const SESSIONS_KEY = "draffiq-sessions-v2";
  const OLD_STORAGE_KEY = "draffiq-chat-v1";

  const form = document.getElementById("chat-form");
  const textarea = document.getElementById("query");
  const messages = document.getElementById("messages");
  const sendBtn = document.getElementById("send-btn");
  const printBtn = document.getElementById("print-btn");
  const shareBtn = document.getElementById("share-btn");
  const newBtn = document.getElementById("new-btn");
  const menuBtn = document.getElementById("menu-btn");
  const landingOverlay = document.getElementById("landing-overlay");
  const landingCta = document.getElementById("landing-cta");
  const chatSection = document.getElementById("chat-section");
  const menuDropdown = document.getElementById("menu-dropdown");
  const homeLink = document.getElementById("home-link");
  const chatLink = document.getElementById("chat-link");
  const sessionListEl = document.getElementById("session-list");
  const sidebarNewBtn = document.getElementById("sidebar-new-btn");

  let sessions = [];
  let activeSessionId = null;
  let currentMode = "quick"; // quick | deep

  // ×“×•×’×××•×ª ×œ×¤×¨×•××¤×˜×™× ××•×›× ×™×
  const EXAMPLE_PROMPTS = [
    {
      label: "× ×™×ª×•×— ×¢×•××§ â€“ ×× ×™×”",
      text: "×ª×Ÿ ×œ×™ × ×™×ª×•×— ×¢×•××§ ×¢×œ ×× ×™×™×ª ______ ×¢× ×“×’×© ×¢×œ ××•×“×œ ×¢×¡×§×™, ×™×ª×¨×•×Ÿ ×ª×—×¨×•×ª×™ ×•××‘× ×” ×©×•×§ ×‘-5â€“10 ×©× ×™× ×§×“×™××”."
    },
    {
      label: "×”×©×•×•××” ×‘×™×Ÿ ×©× ×™ × ×›×¡×™×",
      text: "×”×©×•×•×” ×‘×™×Ÿ ×× ×™×™×ª ______ ×œ××’\"×— ______ ×‘×¨××ª ×¡×™×›×•× ×™×, ××•×“×œ ×¢×¡×§×™, ×ª×–×¨×™× ×•×ª×¨×—×™×© ×‘×¡×™×¡×™ ×œ×©× ×™× ×”×§×¨×•×‘×•×ª."
    },
    {
      label: "× ×™×ª×•×— ×¡×§×˜×•×¨ â€“ ×‘× ×§×™×",
      text: "× ×ª×— ××ª ×¡×§×˜×•×¨ ×”×‘× ×§×™× ×‘×™×©×¨××œ: ××‘× ×” ×©×•×§, ×¨×’×•×œ×¦×™×”, ×¨×•×•×—×™×•×ª, ×—×©×™×¤×•×ª ××¨×›×–×™×•×ª ×•×¡×™×›×•× ×™× ×¢×™×§×¨×™×™×."
    },
    {
      label: "Quick-Scan â€“ ×“×•×— ×¨×‘×¢×•× ×™",
      text: "×‘×¦×¢ Quick-Scan ×¢×œ ×”×“×•×— ×”×¨×‘×¢×•× ×™ ×”××—×¨×•×Ÿ ×©×œ ______, ×ª×•×š ×“×’×© ×¢×œ ×¦××™×—×”, ×¨×•×•×—×™×•×ª, ×—×•×‘ ×•-Red Flags ××”×•×ª×™×™×."
    }
  ];

  function setViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty("--vh", vh + "px");
  }
  window.addEventListener("load", setViewportHeight);
  window.addEventListener("resize", setViewportHeight);
  window.addEventListener("orientationchange", setViewportHeight);

  // ×©×•××¨×™× ×’×•×‘×” ×§×‘×•×¢ â€“ ××™×Ÿ ×’×“×™×œ×” ×¢× ×”×˜×§×¡×˜
  function autoResizeTextarea(el) {
    // no-op â€“ × ×©××¨ ×‘×’×•×‘×” ×§×‘×•×¢
  }

  if (textarea) {
    textarea.addEventListener("input", () => autoResizeTextarea(textarea));
    textarea.addEventListener("focus", () => {
      setTimeout(() => {
        messages.scrollTop = messages.scrollHeight;
      }, 50);
    });
  }

  // ×”×•×¤×š ×˜×§×¡×˜ ×¨×’×™×œ ×œ×œ×™× ×§×™× ×œ×—×™×¦×™× (×¢× escape ×‘×¡×™×¡×™)
  function renderTextWithLinks(text) {
    if (!text) return "";
    let escaped = text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

    const urlRegex = /(https?:\/\/[^\s)]+)/g;

    escaped = escaped.replace(urlRegex, (url) => {
      let clean = url;
      let trailing = "";

      while (/[),.!?]$/.test(clean)) {
        trailing = clean.slice(-1) + trailing;
        clean = clean.slice(0, -1);
      }

      return `<a href="${clean}" target="_blank" rel="noopener noreferrer" class="inline-link">ğŸ”— ×§×™×©×•×¨</a>${trailing}`;
    });

    return escaped;
  }

  function saveSessions() {
    try {
      const payload = {
        sessions,
        activeSessionId
      };
      localStorage.setItem(SESSIONS_KEY, JSON.stringify(payload));
    } catch (e) {
      // ×œ× ×§×¨×™×˜×™ ×× × ×›×©×œ â€“ ×××©×™×›×™× ×‘×œ×™ ×œ×”×¤×™×œ ××ª ×”-UI
    }
  }

  function getActiveSession() {
    return sessions.find((s) => s.id === activeSessionId) || null;
  }

  function renderMessagesForSession(session, options = {}) {
    const { scroll = true } = options;
    if (!messages) return;

    // ××¡×™×¨ ××ª ×›×œ ×”×©×•×¨×•×ª ×”×“×™× ××™×•×ª ×•××©××™×¨ ××ª ×”×•×“×¢×ª ×”××¢×¨×›×ª
    const rows = messages.querySelectorAll(".message-row");
    rows.forEach((r) => r.remove());

    if (!session || !Array.isArray(session.messages)) {
      if (scroll) messages.scrollTop = messages.scrollHeight;
      return;
    }

    session.messages.forEach((m) => {
      appendMessage(m.text, m.role, { persist: false, scroll: false });
    });

    if (scroll) {
      messages.scrollTop = messages.scrollHeight;
    }
  }

  function renderSessionList() {
    if (!sessionListEl) return;
    sessionListEl.innerHTML = "";

    sessions.forEach((sess) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className =
        "session-item" + (sess.id === activeSessionId ? " active" : "");
      btn.textContent = sess.title || "×©×™×—×” ×œ×œ× ×›×•×ª×¨×ª";
      btn.addEventListener("click", () => {
        if (sess.id === activeSessionId) return;
        activeSessionId = sess.id;
        saveSessions();
        renderSessionList();
        renderMessagesForSession(sess, { scroll: false });
        if (textarea) textarea.focus();
      });
      sessionListEl.appendChild(btn);
    });
  }

  function createNewSession() {
    const id = "s_" + Date.now();
    const session = {
      id,
      title: "×©×™×—×” ×—×“×©×”",
      createdAt: Date.now(),
      messages: []
    };
    sessions.push(session);
    activeSessionId = id;
    saveSessions();
    renderSessionList();
    renderMessagesForSession(session, { scroll: false });
    if (textarea) {
      textarea.value = "";
      textarea.focus();
    }
  }

  function migrateOldHistoryIfNeeded() {
    try {
      const raw = localStorage.getItem(OLD_STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || !parsed.length) return;

      const id = "s_" + Date.now();
      sessions = [
        {
          id,
          title: "×©×™×—×” ×§×•×“××ª",
          createdAt: Date.now(),
          messages: parsed
        }
      ];
      activeSessionId = id;
      // ××•×¤×¦×™×•× ×œ×™ â€“ × ×™×§×•×™ ×”×™×©×Ÿ
      // localStorage.removeItem(OLD_STORAGE_KEY);
    } catch (e) {
      // ××ª×¢×œ××™×
    }
  }

  function loadSessions() {
    try {
      const raw = localStorage.getItem(SESSIONS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && Array.isArray(parsed.sessions)) {
          sessions = parsed.sessions;
          activeSessionId =
            parsed.activeSessionId ||
            (parsed.sessions[0] && parsed.sessions[0].id) ||
            null;
        }
      }

      if (!sessions || !sessions.length) {
        migrateOldHistoryIfNeeded();
      }

      if (!sessions || !sessions.length) {
        const id = "s_" + Date.now();
        sessions = [
          {
            id,
            title: "×©×™×—×” ×—×“×©×”",
            createdAt: Date.now(),
            messages: []
          }
        ];
        activeSessionId = id;
      }
    } catch (e) {
      const id = "s_" + Date.now();
      sessions = [
        {
          id,
          title: "×©×™×—×” ×—×“×©×”",
          createdAt: Date.now(),
          messages: []
        }
      ];
      activeSessionId = id;
    }
  }

  function appendMessage(text, role, options = {}) {
    const { persist = true, scroll = true } = options;
    if (!messages) return;

    const row = document.createElement("div");
    row.className = "message-row " + role;

    const avatarWrap = document.createElement("div");
    avatarWrap.className = "message-avatar";
    const avatar = document.createElement("div");
    avatar.className =
      "avatar-circle " + (role === "user" ? "avatar-user" : "avatar-assistant");
    avatar.textContent = role === "user" ? "YOU" : "";
    avatarWrap.appendChild(avatar);

    const contentWrap = document.createElement("div");
    contentWrap.className = "message-content";
    const meta = document.createElement("div");
    meta.className = "message-meta";
    meta.textContent = role === "user" ? "××©×ª××©" : "DRAFFIQ AI";
    const body = document.createElement("div");
    body.innerHTML = renderTextWithLinks(text);

    contentWrap.appendChild(meta);
    contentWrap.appendChild(body);
    row.appendChild(contentWrap);
    row.appendChild(avatarWrap);
    messages.appendChild(row);

    if (scroll) {
      messages.scrollTop = messages.scrollHeight;
    }

    if (persist) {
      const session = getActiveSession();
      if (session) {
        // ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª ×©×™×—×” ×œ×¤×™ ×”×•×“×¢×ª ×”××©×ª××© ×”×¨××©×•× ×”
        if (
          role === "user" &&
          Array.isArray(session.messages) &&
          session.messages.length === 0
        ) {
          let title = text.replace(/\s+/g, " ").trim();
          if (title.length > 28) {
            title = title.slice(0, 28) + "â€¦";
          }
          session.title = title || "×©×™×—×” ×—×“×©×”";
          renderSessionList();
        }

        if (!Array.isArray(session.messages)) {
          session.messages = [];
        }
        session.messages.push({ role, text });
        saveSessions();
      }
    }
  }

  function appendThinking() {
    const row = document.createElement("div");
    row.className = "message-row assistant";
    row.dataset.thinking = "true";

    const avatarWrap = document.createElement("div");
    avatarWrap.className = "message-avatar";
    const avatar = document.createElement("div");
    avatar.className = "avatar-circle avatar-assistant";
    avatar.textContent = "";
    avatarWrap.appendChild(avatar);

    const contentWrap = document.createElement("div");
    contentWrap.className = "message-content";
    const meta = document.createElement("div");
    meta.className = "message-meta";
    meta.textContent = "DRAFFIQ AI";
    const dots = document.createElement("div");
    dots.className = "thinking-dots";
    dots.innerHTML = `
      <span class="thinking-dot"></span>
      <span class="thinking-dot"></span>
      <span class="thinking-dot"></span>
    `;

    contentWrap.appendChild(meta);
    contentWrap.appendChild(dots);
    row.appendChild(contentWrap);
    row.appendChild(avatarWrap);
    messages.appendChild(row);
    return row;
  }

  async function callApi(query) {
    const response = await fetch("/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ query })
    });
    if (!response.ok) {
      let err;
      try {
        err = await response.json();
      } catch {
        err = {};
      }
      throw new Error(err.error || "××™×¨×¢×” ×ª×§×œ×” ×‘×¦×“ ×”×©×¨×ª.");
    }
    const data = await response.json();
    if (!data.ok) {
      throw new Error(data.error || "××™×¨×¢×” ×ª×§×œ×” ×‘×¦×“ ×”×©×¨×ª.");
    }
    return data.answer;
  }

  // ××•×¦×™× ××ª ×›×œ ×”×©×™×—×” ×”× ×•×›×—×™×ª ×›×˜×§×¡×˜ ×¤×©×•×˜ (×œ×©×™×ª×•×£)
  function getConversationPlainText() {
    const session = getActiveSession();
    if (session && Array.isArray(session.messages) && session.messages.length > 0) {
      return session.messages
        .map((m) => (m.role === "user" ? "YOU" : "DRAFFIQ") + ":\n" + m.text)
        .join("\n\n");
    }
    const rows = messages.querySelectorAll(".message-row");
    const parts = [];
    rows.forEach((row) => {
      const isUser = row.classList.contains("user");
      const label = isUser ? "YOU" : "DRAFFIQ";
      const contentEl = row.querySelector(".message-content");
      if (!contentEl) return;
      const text = contentEl.innerText.trim();
      if (!text) return;
      parts.push(label + ":\n" + text);
    });
    return parts.join("\n\n");
  }

  // ×”×“×¤×¡×” / PDF
  if (printBtn) {
    printBtn.addEventListener("click", () => {
      window.print();
    });
  }

  // ×©×™×ª×•×£ ×œ×¡×œ×•×œ××¨ (Web Share API + fallback)
  if (shareBtn) {
    shareBtn.addEventListener("click", async () => {
      const text = getConversationPlainText() || "DRAFFIQ â€“ ×©×™×—×” ×¨×™×§×”.";
      const title = "DRAFFIQ â€“ ×©×™×—×ª ××—×§×¨";
      const url = window.location.href;
      if (navigator.share) {
        try {
          await navigator.share({ title, text, url });
        } catch (e) {
          // ×× ×”××©×ª××© ×‘×™×˜×œ â€“ ××ª×¢×œ××™×
        }
      } else {
        try {
          await navigator.clipboard.writeText(text + "\n\n" + url);
          alert("×”×˜×§×¡×˜ ×•×”×§×™×©×•×¨ ×”×•×¢×ª×§×• ×œ×œ×•×—. × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ×™×“× ×™×ª ×‘××¤×œ×™×§×¦×™×™×ª ×©×™×ª×•×£.");
        } catch {
          alert("×©×™×ª×•×£ ××•×˜×•××˜×™ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”. × ×¡×” ×œ×”×¢×ª×™×§ ×™×“× ×™×ª.");
        }
      }
    });
  }

  // ×¤×•× ×§×¦×™×•×ª ×œ×“×£ ×”× ×—×™×ª×” (×•×™×œ×•×Ÿ) â€“ ×¢×¦×™×¨×” ×¢×“ ×œ×—×™×¦×” ×¢×œ CTA
  function hideLandingOverlay() {
    if (!landingOverlay || landingOverlay.classList.contains("hidden")) return;
    landingOverlay.classList.add("hidden");
    if (chatSection && typeof chatSection.scrollIntoView === "function") {
      chatSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }

  if (landingCta) {
    landingCta.addEventListener("click", hideLandingOverlay);
  }

  function handleNewChatClick() {
    createNewSession();
    if (menuDropdown) menuDropdown.classList.remove("open");
  }

  if (newBtn) {
    newBtn.addEventListener("click", handleNewChatClick);
  }

  if (sidebarNewBtn) {
    sidebarNewBtn.addEventListener("click", handleNewChatClick);
  }

  // ×ª×¤×¨×™×˜ × ×™×•×•×˜
  function toggleMenu() {
    if (!menuDropdown) return;
    menuDropdown.classList.toggle("open");
  }

  if (menuBtn) {
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu();
    });
  }

  if (homeLink) {
    homeLink.addEventListener("click", () => {
      window.location.href = "/";
    });
  }

  if (chatLink) {
    chatLink.addEventListener("click", () => {
      if (chatSection && typeof chatSection.scrollIntoView === "function") {
        chatSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      if (menuDropdown) menuDropdown.classList.remove("open");
    });
  }

  // ×¡×’×™×¨×ª ×ª×¤×¨×™×˜ ×‘×œ×—×™×¦×” ××—×•×¥
  document.addEventListener("click", (e) => {
    if (!menuDropdown || !menuDropdown.classList.contains("open")) return;
    const target = e.target;
    if (
      target === menuBtn ||
      (menuBtn && menuBtn.contains(target)) ||
      menuDropdown.contains(target)
    ) {
      return;
    }
    menuDropdown.classList.remove("open");
  });

  // ×¨×™× ×“×•×¨ ×›×¤×ª×•×¨×™ ×”×“×•×’×××•×ª
  function renderPromptExamples() {
    const container = document.getElementById("promptExamplesContainer");
    if (!container || !textarea) return;

    const buttonsHtml = EXAMPLE_PROMPTS.map(
      (ex, idx) => `
        <button type="button" class="example-btn" data-idx="${idx}">
          ${ex.label}
        </button>
      `
    ).join("");

    container.innerHTML = `
      <div class="prompt-examples">
        <span class="examples-label">×“×•×’×××•×ª ×œ×©××™×œ×ª×•×ª:</span>
        ${buttonsHtml}
      </div>
    `;

    container.addEventListener("click", (e) => {
      const btn = e.target.closest(".example-btn");
      if (!btn) return;
      const idx = btn.getAttribute("data-idx");
      const example = EXAMPLE_PROMPTS[idx];
      if (!example) return;
      textarea.value = example.text;
      autoResizeTextarea(textarea);
      textarea.focus();
    });
  }

  // ××¦×‘ ×¢×‘×•×“×” â€“ Quick / Deep
  function setupModeToggle() {
    const buttons = document.querySelectorAll(".mode-btn");
    if (!buttons.length) return;

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        buttons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const mode = btn.getAttribute("data-mode");
        currentMode = mode === "deep" ? "deep" : "quick";
      });
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    setViewportHeight();
    loadSessions();
    renderSessionList();
    renderMessagesForSession(getActiveSession(), { scroll: false });
    renderPromptExamples();
    setupModeToggle();
  });

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const rawQuery = textarea.value.trim();
      if (!rawQuery) return;

      const modePrefix =
        currentMode === "deep"
          ? "××¦×‘ ×¢×‘×•×“×”: Deep-Dive â€“ × ×™×ª×•×— ×¢×•××§. "
          : "××¦×‘ ×¢×‘×•×“×”: Quick-Scan â€“ ×¡×¨×™×§×” ××”×™×¨×”. ";

      const finalQuery = modePrefix + rawQuery;

      appendMessage(finalQuery, "user", { scroll: true });
      textarea.value = "";
      autoResizeTextarea(textarea);
      textarea.focus();
      sendBtn.disabled = true;
      const originalLabel = sendBtn.querySelector(".label").textContent;
      sendBtn.querySelector(".label").textContent = "××¢×‘×“...";
      const thinkingRow = appendThinking();
      try {
        const answer = await callApi(finalQuery);
        thinkingRow.remove();
        appendMessage(answer, "assistant", { scroll: false });
      } catch (err) {
        thinkingRow.remove();
        appendMessage(
          "×”×™×™×ª×” ×‘×¢×™×” ×‘×¢×™×‘×•×“ ×”×‘×§×©×”: " + (err.message || "×©×’×™××” ×œ× ×™×“×•×¢×”."),
          "assistant",
          { scroll: false }
        );
      } finally {
        sendBtn.disabled = false;
        sendBtn.querySelector(".label").textContent = originalLabel;
      }
    });
  }
</script>

</body>

</html>
