<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>DRAFFIQ AI â€“ TASE Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Palette - Clean Fintech */
      --primary: #111827;
      --primary-hover: #000000;

      --bg-app: #f3f5f9;
      --bg-panel: #ffffff;

      --bubble-user: #1f2937;
      --text-user: #ffffff;

      --bubble-ai: #f4f6f8;
      --text-ai: #111827;

      --border-subtle: #e5e7eb;
      --text-muted: #6b7280;

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-xl: 28px;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
        0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-float: 0 10px 30px -5px rgba(0, 0, 0, 0.08);

      --vh: 1vh;
    }

    * {
      box-sizing: border-box;
      outline: none;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: 'Rubik', Rubik, Rubik, sans-serif;
      background-color: var(--bg-app);
      color: var(--primary);
      display: flex;
      flex-direction: column;
      overflow-y: auto; /* ×”×™×” hidden â€“ ×¢×›×©×™×• ×™×© ×’×œ×™×œ×” */
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 99px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* ===== Landing Overlay ===== */
    .landing-overlay {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease, visibility 0.5s;
    }

    .landing-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .landing-content {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      animation: fadeInLogin 0.8s ease-out;
    }

    .landing-icon {
      width: 35px;
      height: 35px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 24%, #9ca3af 100%);
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.55),
        0 1px 1.5px rgba(15, 23, 42, 0.18);
      animation: landingBounce 1.5s cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    .landing-title {
      font-size: 2.1rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #111827 0%, #000000 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .landing-subtitle {
      font-size: 1.0rem;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: -6px;
    }

    .landing-cta {
      margin-top: 12px;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 10px 28px;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 99px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .landing-cta:hover {
      background: var(--primary);
      color: #ffffff;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }

    @keyframes fadeInLogin {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes landingBounce {
      0% {
        transform: translateY(-20px) scale(0.9);
        opacity: 0;
      }

      35% {
        transform: translateY(2px) scale(1.02);
        opacity: 1;
      }

      65% {
        transform: translateY(-6px) scale(0.98);
      }

      100% {
        transform: translateY(0) scale(1);
      }
    }

    /* ===== Top Bar ===== */
    .top-bar {
      height: 64px;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar-inner {
      width: 100%;
      max-width: 1400px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .brand-logo-small {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 22%, #9ca3af 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 0;
      font-size: 0rem;
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.35),
        0 1px 2px rgba(15, 23, 42, 0.18);
      margin-top: 3px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .brand-text h1 {
      font-size: 1.0rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.5px;
      line-height: 1;
    }

    .brand-text span {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-top: 2px;
      line-height: 1.1;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-badge {
      font-size: 0.7rem;
      background: #f3f4f6;
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
      display: none;
    }

    @media (min-width: 768px) {
      .status-badge {
        display: block;
      }
    }

    .icon-btn {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      color: var(--primary);
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: #f3f4f6;
    }

    .new-chat-btn-top {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.1s;
    }

    .new-chat-btn-top:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .menu-dropdown {
      position: absolute;
      top: 60px;
      left: 24px;
      background: #fff;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 6px;
      display: none;
      min-width: 180px;
      z-index: 200;
    }

    .menu-dropdown.open {
      display: flex;
      flex-direction: column;
    }

    .menu-item {
      text-align: right;
      background: none;
      border: none;
      padding: 10px 14px;
      width: 100%;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--primary);
    }

    .menu-item:hover {
      background: #f9fafb;
    }

    /* ===== Research Menu in Top Bar ===== */
    .research-menu {
      position: relative;
    }

    .research-dropdown {
      position: absolute;
      top: 60px;
      left: 0;
      background: #fff;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 8px 10px;
      min-width: 230px;
      display: none;
      z-index: 210;
    }

    .research-dropdown.open {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .research-section {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .research-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .research-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #f9fafb;
      outline: none;
      margin-top: 4px;
    }

    .research-item {
      width: 100%;
      text-align: right;
      background: none;
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--primary);
    }

    .research-item:hover {
      background: #f3f4f6;
    }

    /* ===== Main Layout ===== */
    .app-shell {
      flex: 1;
      overflow: visible; /* ×”×™×” hidden â€“ ×¢×›×©×™×• ×”×’×•×£ ×”×•× ×–×” ×©×’×•×œ×œ */
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app-container {
      width: 100%;
      max-width: 1400px;
      display: flex;
      gap: 20px;
      height: 100%;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sidebar-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .sidebar-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-header-actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #9ca3af;
      padding: 0;
    }

    .sidebar-header-actions button:hover {
      color: #4b5563;
    }

    .session-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* ===== Session items with 3-dots menu ===== */
    .session-item-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px;
      border-radius: var(--radius-sm);
    }

    .session-item-main {
      text-align: right;
      border: none;
      background: transparent;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      color: #374151;
      cursor: pointer;
      transition: background 0.15s;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-item-main:hover {
      background: #f3f4f6;
    }

    .session-item-wrapper.active .session-item-main {
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 500;
    }

    .session-item-menu-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #9ca3af;
      padding: 2px 4px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .session-item-menu-btn:hover {
      background: #f3f4f6;
      color: #4b5563;
    }

    .session-item-menu {
      position: absolute;
      left: 6px;
      top: 100%;
      margin-top: 4px;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      box-shadow: var(--shadow-md);
      padding: 4px;
      min-width: 140px;
      z-index: 160;
      display: none;
    }

    .session-item-menu.open {
      display: block;
    }

    .session-item-menu-item {
      width: 100%;
      text-align: right;
      border: none;
      background: transparent;
      padding: 6px 8px;
      font-size: 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      color: #111827;
    }

    .session-item-menu-item:hover {
      background: #f3f4f6;
    }

    /* Chat Area */
    .chat-panel {
      flex: 1;
      min-width: 0;
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      scroll-behavior: smooth;
    }

    .message-row {
      display: flex;
      width: 100%;
      margin-bottom: 8px;
    }

    .message-row.user {
      justify-content: flex-start;
    }

    .message-row.user .message-content {
      background: var(--bubble-user);
      color: var(--text-user);
      border-radius: 20px 4px 20px 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .message-row.assistant {
      justify-content: flex-end;
    }

    .message-row.assistant .message-content {
      background: #ffffff;
      color: var(--text-ai);
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: var(--shadow-md);
    }

    .message-content {
      max-width: 80%;
      padding: 14px 20px;
      font-size: 0.95rem;
      line-height: 1.6;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-content a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }

    .message-avatar {
      display: none;
    }

    .message.system {
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
      padding: 16px;
      border-radius: var(--radius-md);
      text-align: right;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 12px auto;
      max-width: 700px;
    }

    .system-hero-title {
      font-size: 1rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .system-hero-sub {
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .system-hero-list {
      list-style: none;
      padding: 0;
      margin: 0 0 8px 0;
    }

    .system-hero-list li {
      margin-bottom: 4px;
    }

    .system-hero-list li::before {
      content: "â€¢ ";
    }

    .system-hero-hint {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .system-about-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .system-about-cta {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .system-about-cta a {
      color: #2563eb;
      text-decoration: none;
    }

    .system-about-cta a:hover {
      text-decoration: underline;
    }

    /* Input Area */
    .input-area-wrapper {
      padding: 16px 20px 18px;
      background: linear-gradient(to top, #ffffff 80%, rgba(255, 255, 255, 0));
      z-index: 10;
    }

    .input-box-container {
      max-width: 860px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      border-radius: 24px;
      padding: 6px 8px 6px 16px;
      box-shadow: var(--shadow-float);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-box-container:focus-within {
      border-color: #9ca3af;
      box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.12);
    }

    .textarea-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    textarea {
      flex: 1;
      border: none;
      resize: none;
      background: transparent;
      max-height: 80px;
      min-height: 20px;
      height: 20px;
      font-family: inherit;
      font-size: 0.9rem;
      line-height: 1.4;
      padding: 6px 0;
      color: var(--primary);
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.1s, background 0.2s;
      margin-bottom: 2px;
      font-size: 0.9rem;
    }

    .send-btn:disabled {
      background: #e5e7eb;
      cursor: not-allowed;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 8px;
      margin-top: 2px;
    }

    .work-modes {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }

    .work-modes-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .work-modes-pills {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .work-mode-option {
      border: none;
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 0.75rem;
      background: #f3f4f6;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .work-mode-option.active {
      background: #111827;
      color: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .meta-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-inline-start: auto;
    }

    .meta-field {
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }

    .meta-field label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .meta-field select {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 3px 10px;
      font-size: 0.8rem;
      background: #f9fafb;
      outline: none;
    }

    .tools-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 2px;
      padding-inline-end: 8px;
    }

    .mode-switch {
      display: flex;
      gap: 4px;
      background: #f3f4f6;
      padding: 3px;
      border-radius: 99px;
    }

    .mode-option {
      border: none;
      background: transparent;
      font-size: 0.75rem;
      padding: 4px 12px;
      border-radius: 99px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
      white-space: nowrap;
    }

    .mode-option.active {
      background: #fff;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-weight: 500;
    }

    .extra-actions {
      display: flex;
      gap: 8px;
    }

    .action-pill {
      background: transparent;
      border: none;
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .action-pill:hover {
      background: #f3f4f6;
      color: var(--primary);
    }

    /* ×›×¤×ª×•×¨×™ ×”×©××œ×•×ª â€“ ××ª×—×ª ×œ××™× ×¤×•×˜, ×‘×©×•×¨×•×ª ××™××™×Ÿ ×œ×©×××œ */
    .examples-container {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 860px;
      width: 100%;
      margin-inline: auto;
      justify-content: flex-start;
    }

    .example-chip {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 99px;
      padding: 6px 14px;
      font-size: 0.75rem;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .example-chip:hover {
      background: #fff;
      border-color: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .thinking-dots {
      display: inline-flex;
      gap: 4px;
      padding: 0 4px;
    }

    .thinking-dot {
      width: 6px;
      height: 6px;
      background: #9ca3af;
      border-radius: 50%;
      animation: pulse 1.4s infinite;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 0.4;
        transform: scale(0.8);
      }

      50% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ===== Mobile Layout Tweaks ===== */
    @media (max-width: 900px) {
      .app-shell {
        padding: 8px;
      }

      .app-container {
        flex-direction: column;
        height: calc(100vh - 64px);
        gap: 8px;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        padding: 8px 10px;
        border-radius: 14px;
        margin-bottom: 4px;
      }

      .sidebar-header {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
        flex-shrink: 0;
      }

      .session-list {
        flex: 1;
        flex-direction: row;
        gap: 6px;
        overflow-x: auto;
        overflow-y: hidden;
      }

      .session-item-wrapper {
        min-width: 140px;
      }

      .session-item-main {
        font-size: 0.75rem;
        padding: 6px 10px;
        max-width: 180px;
      }

      .chat-panel {
        border-radius: 16px;
      }

      #messages {
        padding: 12px;
      }

      .message-content {
        max-width: 95%;
      }

      .meta-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .meta-inline {
        width: 100%;
        justify-content: flex-start;
      }

      .tools-row {
        flex-wrap: wrap;
        gap: 6px;
      }

      .mode-switch {
        margin-bottom: 4px;
      }
    }
  </style>
</head>

<body>
  <!-- Landing -->
  <div id="landing-overlay" class="landing-overlay">
    <div class="landing-content">
      <div class="landing-icon"></div>
      <div style="text-align:center;">
        <h1 class="landing-title">DRAFFIQ AI</h1>
        <div class="landing-subtitle">××•×“×™×¢×™×Ÿ ×¢×¡×§×™ ×œ×©×•×§ ×”×”×•×Ÿ ×”×™×©×¨××œ×™</div>
      </div>
      <button type="button" id="landing-cta" class="landing-cta">
        <span>×›× ×™×¡×” ×œ××¢×¨×›×ª</span>
        <span>â†</span>
      </button>
    </div>
  </div>

  <!-- Top bar -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="brand">
        <div class="brand-logo-small">DF</div>
        <div class="brand-text">
          <h1>DRAFFIQ</h1>
          <!-- ×›××Ÿ ×§×™×¦×¨× ×•, ×‘×œ×™ "×”×™×©×¨××œ×™" -->
          <span>××•×“×™×¢×™×Ÿ ×¢×¡×§×™ ×œ×©×•×§ ×”×”×•×Ÿ</span>
        </div>
      </div>

      <div class="top-actions">
        <div class="status-badge">TASE LIVE</div>
        <button id="new-btn" class="new-chat-btn-top">+ ×©×™×—×” ×—×“×©×”</button>

        <!-- ×ª×¤×¨×™×˜ ××—×§×¨ ×•×›×œ×™× -->
        <div class="research-menu">
          <button id="research-btn" class="icon-btn" title="×›×œ×™ ××—×§×¨">âš™ï¸</button>
          <div id="research-dropdown" class="research-dropdown">
            <div class="research-section">××¦×‘ ××—×§×¨</div>
            <div class="research-pills">
              <button type="button" class="work-mode-option active" data-mode="stock">×× ×™×•×ª</button>
              <button type="button" class="work-mode-option" data-mode="bond">××’"×—</button>
              <button type="button" class="work-mode-option" data-mode="sector">×¡×§×˜×•×¨×™×</button>
            </div>

            <div class="research-section">×¡×•×’ × ×›×¡</div>
            <select id="asset-type" class="research-select">
              <option value="">×œ×œ×</option>
              <option value="equity">×× ×™×”</option>
              <option value="bond_gov">××’"×— ×××©×œ×ª×™</option>
              <option value="bond_corp">××’"×— ×§×•× ×¦×¨× ×™</option>
              <option value="fund">×§×¨×Ÿ / ETF</option>
              <option value="index">××“×“</option>
            </select>

            <div class="research-section">×›×œ×™×</div>
            <button type="button" class="research-item" id="deep-mode-btn">Deep Dive</button>
            <button type="button" class="research-item" id="share-btn">×©×ª×£</button>
            <button type="button" class="research-item" id="print-btn">PDF</button>
          </div>
        </div>

        <button id="menu-btn" class="icon-btn">â˜°</button>

        <div id="menu-dropdown" class="menu-dropdown">
          <button class="menu-item" id="home-link">××¡×š ×”×‘×™×ª</button>
          <button class="menu-item" id="chat-link">×§×¤×™×¦×” ×œ×¦'××˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Layout -->
  <div class="app-shell">
    <div class="app-container">

      <aside class="sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×•×ª</span>
          <div class="sidebar-header-actions">
            <button id="sidebar-new-btn" title="×©×™×—×” ×—×“×©×”">+</button>
          </div>
        </div>
        <div class="session-list" id="session-list"></div>
      </aside>

      <main class="chat-panel" id="chat-section">
        <div id="messages">
          <div class="message system">
            <div class="system-hero-title">×™×—×™×“×ª ××—×§×¨ ×œ×©×•×§ ×”×”×•×Ÿ ×”×™×©×¨××œ×™</div>
            <div class="system-hero-sub">
              ×›×ª×•×‘ ×©××œ×ª ××—×§×¨ ×›×¤×™ ×©×”×™×™×ª ×× ×¡×— ×œ×× ×œ×™×¡×˜ ×‘×›×™×¨ â€“ DRAFFIQ AI ×××¤×” ×¢×‘×•×¨×š ×¡×™×›×•× ×™×, ×”×–×“×× ×•×™×•×ª ×•×ª×¡×¨×™×˜×™× ×§×“×™××”.
            </div>
            <ul class="system-hero-list">
              <li>× ×™×ª×•×— ×× ×™×•×ª, ××’"×— ×•×¡×§×˜×•×¨×™× ×¢× ×“×’×© ×¢×œ ××™×›×•×ª ×“×•×—×•×ª, ××™× ×•×£ ×•×ª×–×¨×™×.</li>
              <li>××™×¦×•×‘ ×”×—×‘×¨×” ××•×œ ××ª×—×¨×•×ª, ××’××•×ª ×¡×§×˜×•×¨ ×•×ª××—×•×¨ ×‘×™×—×¡ ×œ×¡×™×›×•×Ÿ.</li>
              <li>××™×§×•×“ ×‘× ×§×•×“×•×ª ×©×›×“××™ ×œ×—×¤×•×¨ ×‘×”×Ÿ ×™×“× ×™×ª â€“ ×œ× ×”×—×œ×¤×” ×©×œ ×‘×“×™×§×” ×× ×•×©×™×ª.</li>
            </ul>
            <div class="system-hero-hint">
              ×‘×¨×™×¨×ª ×”××—×“×œ ×”×™× ××¢× ×” ×¨×’×™×œ. ××¤×©×¨ ×œ×”×“×œ×™×§ <strong>Deep Dive</strong> ×œ× ×™×ª×•×— ××¢××™×§ ×™×•×ª×¨ ×‘××•×ª×” ×©×™×—×”.
              <br>
              ××•××œ×¥ ×œ×‘×—×•×¨ ×¡×•×’ × ×›×¡ ×›×“×™ ×œ×—×“×“ ××ª ×”×ª×©×•×‘×”.
            </div>
          </div>

          <div class="message system">
            <div class="system-about-title">××™ ×¢×•××“ ×××—×•×¨×™ DRAFFIQ?</div>
            <div>
              ×”××¢×¨×›×ª × ×©×¢× ×ª ×¢×œ × ×™×ª×•×— ×˜×§×¡×˜×•××œ×™ ××ª×§×“×, ×©×™×œ×•×‘ ×‘×™×Ÿ ×§×¨×™××ª ×“×•×—×•×ª, ×—×“×©×•×ª ×•×©×™×— ×©×•×§, ×™×—×“ ×¢× ××ª×•×“×•×œ×•×’×™×•×ª ××—×§×¨
              ××¢×•×œ××•×ª ×¤×™× × ×¡×™× ×•× ×™×ª×•×— ×”×ª× ×”×’×•×ª×™.
              ×”××˜×¨×”: ×œ× "×¦'××˜Ö¾×‘×•×˜ ×—×›×", ××œ× ×©×›×‘×ª ×—×©×™×‘×” ×©×¢×•×–×¨×ª ×œ×š ×œ×”×‘×™×Ÿ ××” ×—×©×•×‘ ×œ×§×¨×•× ×•××” ××¤×©×¨ ×œ×“×œ×’.
            </div>
            <div class="system-about-cta">
              ×¨×•×¦×” ×œ×—×‘×¨ ××ª DRAFFIQ ×œ××—×œ×§×ª ×”××—×§×¨ ××• ×œ×§×‘×œ ×’×™×©×” ××ª×§×“××ª (API / ×”×ª×××” ×¡×¤×¦×™×¤×™×ª)?
              × ×™×ª×Ÿ ×œ×¤× ×•×ª ×œ×›×ª×•×‘×ª ×”××™×™×œ: <a href="mailto:info@draffiq.com">info@draffiq.com</a>
            </div>
          </div>
        </div>

        <div class="input-area-wrapper">
          <form id="chat-form">
            <div class="input-box-container">
              <div class="textarea-row">
                <textarea id="query" name="query" rows="1" placeholder="×©××œ ×©××œ×” ×¢×œ ×× ×™×”, ×“×•×— ××• ×¡×§×˜×•×¨..."></textarea>
                <button type="submit" id="send-btn" class="send-btn">â¤</button>
              </div>
            </div>

            <div id="promptExamplesContainer" class="examples-container"></div>

            <div style="text-align:center; margin-top:10px; font-size:0.65rem; color:#9ca3af;">
              ×”××™×“×¢ ××™× ×• ××”×•×•×” ×™×™×¢×•×¥ ×”×©×§×¢×•×ª. ×˜.×œ.×—.
            </div>
          </form>
        </div>
      </main>

    </div>
  </div>

  <script>
    const SESSIONS_KEY = "draffiq-sessions-v2";
    const OLD_STORAGE_KEY = "draffiq-chat-v1";

    const form = document.getElementById("chat-form");
    const textarea = document.getElementById("query");
    const messages = document.getElementById("messages");
    const sendBtn = document.getElementById("send-btn");
    const printBtn = document.getElementById("print-btn");
    const shareBtn = document.getElementById("share-btn");
    const newBtn = document.getElementById("new-btn");
    const menuBtn = document.getElementById("menu-btn");
    const landingOverlay = document.getElementById("landing-overlay");
    const landingCta = document.getElementById("landing-cta");
    const chatSection = document.getElementById("chat-section");
    const menuDropdown = document.getElementById("menu-dropdown");
    const homeLink = document.getElementById("home-link");
    const chatLink = document.getElementById("chat-link");
    const sessionListEl = document.getElementById("session-list");
    const sidebarNewBtn = document.getElementById("sidebar-new-btn");
    const deepModeBtn = document.getElementById("deep-mode-btn");
    const assetTypeSelect = document.getElementById("asset-type");
    const researchBtn = document.getElementById("research-btn");
    const researchDropdown = document.getElementById("research-dropdown");

    let sessions = [];
    let activeSessionId = null;
    let currentMode = "normal";
    let currentWorkMode = "stock";

    const EXAMPLE_PROMPTS = [
      { label: "××¤×ª ×¡×™×›×•× ×™× ×œ×× ×™×”", text: "×‘× ×” ×œ×™ ××¤×ª ×¡×™×›×•× ×™× ×•×”×–×“×× ×•×™×•×ª ×œ×× ×™×™×ª ×¤×•×¢×œ×™× ×œ×©× ×ª×™×™× ×”×§×¨×•×‘×•×ª." },
      { label: "×”×©×•×•××ª ××’\"×—", text: "×”×©×•×•×” ×‘×™×Ÿ ××’\"×— ×××©×œ×ª×™ ×©×§×œ×™ ×œ-10 ×©× ×™× ×œ×‘×™×Ÿ ××’\"×— ×§×•× ×¦×¨× ×™ ×‘×“×™×¨×•×’ AA ×‘××•×ª×• ××—\"×." },
      { label: "×¡×§×˜×•×¨ × ×“×œ\"×Ÿ", text: "××”× ×”×¡×™×›×•× ×™× ×”××¨×›×–×™×™× ×›×™×•× ×‘×¡×§×˜×•×¨ ×”× ×“×œ\"×Ÿ ×”×× ×™×‘ ×‘×™×©×¨××œ, ×•××™×œ×• ×ª×¨×—×™×©×™× ×™×›×•×œ×™× ×œ×©× ×•×ª ××ª ×”×›×™×•×•×Ÿ?" },
      { label: "×“×•×— ××—×¨×•×Ÿ", text: "×‘×¦×¢ × ×™×ª×•×— ×¢×œ ×”×“×•×— ×”××—×¨×•×Ÿ ×©×œ ×‘×–×§, ×¢× ×“×’×© ×¢×œ ×ª×–×¨×™× ××–×•×× ×™× ×•-Red Flags ×¤×•×˜× ×¦×™××œ×™×™×." }
    ];

    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty("--vh", vh + "px");
    }
    window.addEventListener("load", setViewportHeight);
    window.addEventListener("resize", setViewportHeight);

    function autoResizeTextarea(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 80) + 'px';
    }

    if (textarea) {
      textarea.addEventListener("input", () => autoResizeTextarea(textarea));
      textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (form) form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
        }
      });
    }

    function renderTextWithLinks(text) {
      if (!text) return "";
      let escaped = text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      const urlRegex = /(https?:\/\/[^\s)]+)/g;
      return escaped.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">ğŸ“</a>`;
      });
    }

    function saveSessions() {
      try {
        localStorage.setItem(SESSIONS_KEY, JSON.stringify({ sessions, activeSessionId }));
      } catch (e) { }
    }

    function getActiveSession() {
      return sessions.find((s) => s.id === activeSessionId) || null;
    }

    function renderMessagesForSession(session, options = {}) {
      const { scroll = true } = options;
      if (!messages) return;

      const rows = messages.querySelectorAll(".message-row");
      rows.forEach(r => r.remove());

      if (!session || !Array.isArray(session.messages)) {
        if (scroll) messages.scrollTop = 0;
        return;
      }

      session.messages.forEach(m =>
        appendMessage(m.text, m.role, { persist: false, scroll: false })
      );

      if (scroll) messages.scrollTop = 0;
    }

    function renderSessionList() {
      if (!sessionListEl) return;
      sessionListEl.innerHTML = "";

      sessions.forEach(sess => {
        const wrapper = document.createElement("div");
        wrapper.className = "session-item-wrapper" + (sess.id === activeSessionId ? " active" : "");
        wrapper.dataset.sessionId = sess.id;

        // ×›×¤×ª×•×¨ ×¨××©×™ â€“ ×¤×ª×™×—×ª ×”×©×™×—×”
        const mainBtn = document.createElement("button");
        mainBtn.type = "button";
        mainBtn.className = "session-item-main";
        mainBtn.textContent = sess.title ||
          ("×©×™×—×” " + new Date(sess.createdAt).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }));
        mainBtn.title = "×¤×ª×™×—×ª ×©×™×—×”";

        mainBtn.addEventListener("click", () => {
          if (sess.id === activeSessionId) return;
          activeSessionId = sess.id;
          saveSessions();
          renderSessionList();
          renderMessagesForSession(sess);
        });

        // ×›×¤×ª×•×¨ ×©×œ×•×© × ×§×•×“×•×ª
        const menuBtnSession = document.createElement("button");
        menuBtnSession.type = "button";
        menuBtnSession.className = "session-item-menu-btn";
        menuBtnSession.innerHTML = "â‹®";

        // ×ª×¤×¨×™×˜ ×©×™×—×”
        const menu = document.createElement("div");
        menu.className = "session-item-menu";

        const renameItem = document.createElement("button");
        renameItem.type = "button";
        renameItem.className = "session-item-menu-item";
        renameItem.textContent = "×©× ×” ×©× ×©×™×—×”";

        renameItem.addEventListener("click", (e) => {
          e.stopPropagation();
          menu.classList.remove("open");
          const currentTitle = sess.title || "";
          const newTitle = prompt("×©× ×—×“×© ×œ×©×™×—×”:", currentTitle);
          if (newTitle && newTitle.trim()) {
            sess.title = newTitle.trim();
            saveSessions();
            renderSessionList();
          }
        });

        menu.appendChild(renameItem);

        menuBtnSession.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains("open");
          // ×œ×¡×’×•×¨ ××—×¨×™×
          document.querySelectorAll(".session-item-menu.open").forEach(m => m.classList.remove("open"));
          if (!isOpen) {
            menu.classList.add("open");
          }
        });

        wrapper.appendChild(mainBtn);
        wrapper.appendChild(menuBtnSession);
        wrapper.appendChild(menu);

        sessionListEl.appendChild(wrapper);
      });
    }

    function createNewSession() {
      const id = "s_" + Date.now();
      const session = { id, title: "×©×™×—×” ×—×“×©×”", createdAt: Date.now(), messages: [] };
      sessions.unshift(session);
      activeSessionId = id;
      saveSessions();
      renderSessionList();
      renderMessagesForSession(session);
      if (textarea) {
        textarea.value = "";
        autoResizeTextarea(textarea);
        textarea.focus();
      }
    }

    function migrateOldHistoryIfNeeded() {
      try {
        const raw = localStorage.getItem(OLD_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || !parsed.length) return;
        const id = "s_" + Date.now();
        sessions = [{
          id,
          title: "×©×™×—×” ×§×•×“××ª",
          createdAt: Date.now(),
          messages: parsed
        }];
        activeSessionId = id;
      } catch (e) { }
    }

    function loadSessions() {
      try {
        const raw = localStorage.getItem(SESSIONS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && Array.isArray(parsed.sessions)) {
            sessions = parsed.sessions;
            activeSessionId = parsed.activeSessionId || (sessions[0] && sessions[0].id) || null;
          }
        }
        if (!sessions || !sessions.length) {
          migrateOldHistoryIfNeeded();
        }
        if (!sessions || !sessions.length) {
          const id = "s_" + Date.now();
          sessions = [{
            id,
            title: "×©×™×—×” ×—×“×©×”",
            createdAt: Date.now(),
            messages: []
          }];
          activeSessionId = id;
        }
      } catch (e) {
        const id = "s_" + Date.now();
        sessions = [{
          id,
          title: "×©×™×—×” ×—×“×©×”",
          createdAt: Date.now(),
          messages: []
        }];
        activeSessionId = id;
      }
    }

    function appendMessage(text, role, options = {}) {
      const { persist = true, scroll = true } = options;
      if (!messages) return;

      const row = document.createElement("div");
      row.className = "message-row " + role;

      const content = document.createElement("div");
      content.className = "message-content";
      content.innerHTML = renderTextWithLinks(text);
      row.appendChild(content);
      messages.appendChild(row);

      if (scroll) {
        if (role === "assistant") {
          // ×”×¦×’×ª ×ª×—×™×œ×ª ×”×ª×©×•×‘×” â€“ ×œ×’×œ×•×œ ×›×š ×©×”×”×•×“×¢×” ×”×—×“×©×” ××ª×—×™×œ×” ×œ××¢×œ×”
          messages.scrollTop = row.offsetTop;
        } else if (role === "user") {
          messages.scrollTop = messages.scrollHeight;
        }
      }

      if (persist) {
        const session = getActiveSession();
        if (session) {
          if (role === "user" && Array.isArray(session.messages) && session.messages.length === 0) {
            let t = text.replace(/\s+/g, " ").trim();
            if (t.length > 28) t = t.slice(0, 28) + "â€¦";
            session.title = t || "×©×™×—×” ×—×“×©×”";
            renderSessionList();
          }
          if (!Array.isArray(session.messages)) session.messages = [];
          session.messages.push({ role, text });
          saveSessions();
        }
      }
    }

    function appendThinking() {
      const row = document.createElement("div");
      row.className = "message-row assistant";
      const content = document.createElement("div");
      content.className = "message-content";
      content.innerHTML =
        `<div class="thinking-dots">
           <span class="thinking-dot"></span>
           <span class="thinking-dot"></span>
           <span class="thinking-dot"></span>
         </div>`;
      row.appendChild(content);
      messages.appendChild(row);
      return row;
    }

    async function callApi(query) {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      if (!response.ok) {
        let err;
        try {
          err = await response.json();
        } catch {
          err = {};
        }
        throw new Error(err.error || "×©×’×™××” ×‘×¦×“ ×”×©×¨×ª.");
      }
      const data = await response.json();
      if (!data.ok && data.answer === undefined) {
        throw new Error(data.error || "×©×’×™××” ×‘×¦×“ ×”×©×¨×ª.");
      }
      return data.answer ?? "";
    }

    function getConversationPlainText() {
      const session = getActiveSession();
      if (session && Array.isArray(session.messages) && session.messages.length > 0) {
        return session.messages
          .map((m) => (m.role === "user" ? "YOU" : "DRAFFIQ") + ":\n" + m.text)
          .join("\n\n");
      }
      const rows = messages.querySelectorAll(".message-row");
      const parts = [];
      rows.forEach((row) => {
        const isUser = row.classList.contains("user");
        const label = isUser ? "YOU" : "DRAFFIQ";
        const contentEl = row.querySelector(".message-content");
        if (!contentEl) return;
        const text = contentEl.innerText.trim();
        if (!text) return;
        parts.push(label + ":\n" + text);
      });
      return parts.join("\n\n");
    }

    if (printBtn) {
      printBtn.addEventListener("click", () => {
        window.print();
      });
    }

    if (shareBtn) {
      shareBtn.addEventListener("click", async () => {
        const text = getConversationPlainText() || "DRAFFIQ â€“ ×©×™×—×” ×¨×™×§×”.";
        const title = "DRAFFIQ â€“ ×©×™×—×ª ××—×§×¨";
        const url = window.location.href;
        if (navigator.share) {
          try {
            await navigator.share({ title, text, url });
          } catch (e) { }
        } else {
          try {
            await navigator.clipboard.writeText(text + "\n\n" + url);
            alert("×”×˜×§×¡×˜ ×•×”×§×™×©×•×¨ ×”×•×¢×ª×§×• ×œ×œ×•×—. × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ×‘×›×œ ××¤×œ×™×§×¦×™×”.");
          } catch {
            alert("×©×™×ª×•×£ ××•×˜×•××˜×™ ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”. × ×¡×” ×œ×”×¢×ª×™×§ ×™×“× ×™×ª.");
          }
        }
      });
    }

    if (landingCta) {
      landingCta.addEventListener("click", () => {
        landingOverlay.classList.add("hidden");
        if (chatSection && chatSection.scrollIntoView) {
          chatSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    }

    function handleNewChatClick() {
      createNewSession();
      if (menuDropdown) menuDropdown.classList.remove("open");
    }

    if (newBtn) newBtn.addEventListener("click", handleNewChatClick);
    if (sidebarNewBtn) sidebarNewBtn.addEventListener("click", handleNewChatClick);

    if (menuBtn) {
      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (!menuDropdown) return;
        menuDropdown.classList.toggle("open");
      });
    }

    if (homeLink) {
      homeLink.addEventListener("click", () => {
        window.location.href = "/";
      });
    }

    if (chatLink) {
      chatLink.addEventListener("click", () => {
        if (chatSection && chatSection.scrollIntoView) {
          chatSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
        if (menuDropdown) menuDropdown.classList.remove("open");
      });
    }

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×ª×¤×¨×™×˜ ×”××—×§×¨ (âš™ï¸)
    if (researchBtn && researchDropdown) {
      researchBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        researchDropdown.classList.toggle("open");
      });
    }

    // ×¡×’×™×¨×ª ×ª×¤×¨×™×˜×™ top bar + ×ª×¤×¨×™×˜×™ ×©×™×—×•×ª ×‘×œ×—×™×¦×” ×‘×—×•×¥
    document.addEventListener("click", (e) => {
      const target = e.target;

      // ×ª×¤×¨×™×˜ ×¢×œ×™×•×Ÿ
      if (menuDropdown && menuDropdown.classList.contains("open")) {
        if (target !== menuBtn && !(menuBtn && menuBtn.contains(target)) && !menuDropdown.contains(target)) {
          menuDropdown.classList.remove("open");
        }
      }

      // ×ª×¤×¨×™×˜ ××—×§×¨
      if (researchDropdown && researchDropdown.classList.contains("open")) {
        if (!target.closest(".research-menu")) {
          researchDropdown.classList.remove("open");
        }
      }

      // ×ª×¤×¨×™×˜×™ ×©×™×—×•×ª â€“ ×× ×”×œ×—×™×¦×” ×œ× ×‘×ª×•×š wrapper ×©×œ ×©×™×—×”
      if (!target.closest(".session-item-wrapper")) {
        document.querySelectorAll(".session-item-menu.open").forEach(m => m.classList.remove("open"));
      }
    });

    function renderPromptExamples() {
      const container = document.getElementById("promptExamplesContainer");
      if (!container || !textarea) return;
      container.innerHTML = EXAMPLE_PROMPTS.map((ex, i) =>
        `<button type="button" class="example-chip" data-idx="${i}">${ex.label}</button>`
      ).join("");

      container.addEventListener("click", (e) => {
        const btn = e.target.closest(".example-chip");
        if (!btn) return;
        const idx = btn.getAttribute("data-idx");
        const ex = EXAMPLE_PROMPTS[idx];
        if (!ex) return;
        textarea.value = ex.text;
        autoResizeTextarea(textarea);
        textarea.focus();
      });
    }

    function setupModeToggle() {
      if (!deepModeBtn) return;
      deepModeBtn.addEventListener("click", () => {
        const isActive = deepModeBtn.classList.contains("active");
        if (isActive) {
          deepModeBtn.classList.remove("active");
          currentMode = "normal";
        } else {
          deepModeBtn.classList.add("active");
          currentMode = "deep";
        }
      });
    }

    function setupWorkModes() {
      const buttons = document.querySelectorAll(".work-mode-option");
      if (!buttons.length) return;
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const mode = btn.getAttribute("data-mode");
          currentWorkMode = mode || "stock";
        });
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      setViewportHeight();
      loadSessions();
      renderSessionList();
      renderMessagesForSession(getActiveSession(), { scroll: false });
      renderPromptExamples();
      setupModeToggle();
      setupWorkModes();
    });

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const raw = textarea ? textarea.value.trim() : "";
        if (!raw) return;

        appendMessage(raw, "user");

        const metaParts = [];
        if (currentWorkMode) {
          metaParts.push(`WORK_MODE=${currentWorkMode}`);
        }
        if (assetTypeSelect && assetTypeSelect.value) {
          metaParts.push(`ASSET_TYPE=${assetTypeSelect.value}`);
        }

        const metaPrefix = metaParts.length ? "[" + metaParts.join("; ") + "] " : "";

        const queryForApi =
          currentMode === "deep"
            ? metaPrefix + "DEEP_DIVE: " + raw
            : metaPrefix + raw;

        if (textarea) {
          textarea.value = "";
          autoResizeTextarea(textarea);
          textarea.focus();
        }

        if (sendBtn) sendBtn.disabled = true;
        const thinking = appendThinking();

        try {
          const ans = await callApi(queryForApi);
          thinking.remove();

          const safeAnswer = ans || "×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×” ××”×©×¨×ª.";
          appendMessage(safeAnswer, "assistant");
        } catch (err) {
          thinking.remove();
          appendMessage("×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: " + (err.message || "×©×’×™××” ×œ× ×™×“×•×¢×”."), "assistant");
        } finally {
          if (sendBtn) sendBtn.disabled = false;
        }
      });
    }
  </script>
</body>

</html>
