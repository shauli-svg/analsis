<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>DRAFFIQ AI – TASE Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <style>
    :root {
      /* Palette - Clean Fintech */
      --primary: #111827;
      --primary-hover: #000000;

      --bg-app: #f3f5f9;
      --bg-panel: #ffffff;

      --bubble-user: #1f2937;
      --text-user: #ffffff;

      --bubble-ai: #f4f6f8;
      --text-ai: #111827;

      --border-subtle: #e5e7eb;
      --text-muted: #6b7280;

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-xl: 28px;

      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
        0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-float: 0 10px 30px -5px rgba(0, 0, 0, 0.08);

      --vh: 1vh;
    }

    * {
      box-sizing: border-box;
      outline: none;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      /* ביטול נעילת הגלילה – דף יכול לגלול כרגיל */
      /* overflow: hidden; */
    }

    body {
      font-family: 'Heebo', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-app);
      color: var(--primary);
      display: flex;
      flex-direction: column;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 99px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* ===== Landing Overlay ===== */
    .landing-overlay {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease, visibility 0.5s;
    }

    .landing-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .landing-content {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      animation: fadeInLogin 0.8s ease-out;
    }

    .landing-icon {
      width: 35px;
      height: 35px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 24%, #9ca3af 100%);
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.55),
        0 1px 1.5px rgba(15, 23, 42, 0.18);
      animation: landingBounce 1.5s cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    .landing-title {
      font-size: 2.1rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #111827 0%, #000000 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .landing-subtitle {
      font-size: 1.0rem;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: -6px;
    }

    .landing-cta {
      margin-top: 12px;
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 10px 28px;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 99px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .landing-cta:hover {
      background: var(--primary);
      color: #ffffff;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }

    @keyframes fadeInLogin {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes landingBounce {
      0% {
        transform: translateY(-20px) scale(0.9);
        opacity: 0;
      }

      35% {
        transform: translateY(2px) scale(1.02);
        opacity: 1;
      }

      65% {
        transform: translateY(-6px) scale(0.98);
      }

      100% {
        transform: translateY(0) scale(1);
      }
    }

    /* ===== Top Bar ===== */
    .top-bar {
      height: 64px;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar-inner {
      width: 100%;
      max-width: 1400px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .brand-logo-small {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% 20%, #f9fafb, #FF0000 22%, #9ca3af 100%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 0;
      font-size: 0rem;
      color: #f9fafb;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.35),
        0 1px 2px rgba(15, 23, 42, 0.18);
      margin-top: 3px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .brand-text h1 {
      font-size: 1.0rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.5px;
      line-height: 1;
    }

    .brand-text span {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: block;
      margin-top: 2px;
      line-height: 1.1;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-badge {
      font-size: 0.7rem;
      background: #f3f4f6;
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
      display: none;
    }

    @media (min-width: 768px) {
      .status-badge {
        display: block;
      }
    }

    .icon-btn {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      color: var(--primary);
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: #f3f4f6;
    }

    .new-chat-btn-top {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 99px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.1s;
      white-space: nowrap;
    }

    .new-chat-btn-top:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    /* ===== General menu (☰) ===== */
    .menu-dropdown {
      position: absolute;
      top: 60px;
      right: 24px;
      left: auto;
      background: #111827;
      border-radius: var(--radius-md);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.35);
      padding: 6px;
      display: none;
      min-width: 190px;
      z-index: 200;
    }

    .menu-dropdown.open {
      display: flex;
      flex-direction: column;
    }

    .menu-item {
      text-align: right;
      background: none;
      border: none;
      padding: 10px 14px;
      width: 100%;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .menu-item:hover {
      background: rgba(55, 65, 81, 0.9);
    }

    /* ===== Research Menu in Top Bar ===== */
    .research-menu {
      position: relative;
    }

    .icon-btn-settings {
      padding: 6px;
      border-radius: 999px;
      background: #f3f4f6;
      color: var(--primary);
    }

    .icon-btn-settings:hover {
      background: #e5e7eb;
    }

    .settings-icon {
      width: 18px;
      height: 18px;
      display: block;
    }

    .research-dropdown {
      position: absolute;
      top: 60px;
      left: 0;
      background: #fff;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 8px 10px;
      min-width: 230px;
      display: none;
      z-index: 210;
    }

    .research-dropdown.open {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .research-section {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .research-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .research-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #f9fafb;
      outline: none;
      margin-top: 4px;
    }

    .research-item {
      width: 100%;
      text-align: right;
      background: none;
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--primary);
    }

    .research-item:hover {
      background: #f3f4f6;
    }

    /* ===== Main Layout ===== */
    .app-shell {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 20px;
      /* לפני כן height: calc(100vh - 64px) + overflow:hidden – זה חתך את המסך */
      min-height: calc(var(--vh, 1vh) * 100 - 64px);
      overflow: visible;
    }

    .app-container {
      width: 100%;
      max-width: 1400px;
      display: flex;
      gap: 20px;
      /* height: 100%;  -- ביטול: שלא יכפה גובה נעול */
    }

    @media (min-width: 900px) {
      .app-container {
        flex-direction: row-reverse;
      }
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-shadow: var(--shadow-sm);
      /* height: 100%;  -- ביטול: העמודה גדלה לפי התוכן ולא נחתכת */
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sidebar-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .sidebar-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-header-actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #9ca3af;
      padding: 0;
    }

    .sidebar-header-actions button:hover {
      color: #4b5563;
    }

    .session-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* Sidebar mobile dropdown */
    .sidebar-mobile {
      display: none;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .sidebar-mobile-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .sidebar-mobile-select {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #f9fafb;
      color: var(--primary);
      outline: none;
    }

    .sidebar-mobile-new {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #111827;
      color: #ffffff;
      cursor: pointer;
      white-space: nowrap;
    }

    .sidebar-mobile-new:hover {
      background: #000000;
    }

    /* Session items */
    .session-item-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px;
      border-radius: var(--radius-sm);
      gap: 4px;
    }

    .session-item-main {
      text-align: right;
      border: none;
      background: transparent;
      padding: 8px 10px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      color: #374151;
      cursor: pointer;
      transition: background 0.15s;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-item-main:hover {
      background: #f3f4f6;
    }

    .session-item-wrapper.active .session-item-main {
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 500;
    }

    .session-item-menu-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #9ca3af;
      padding: 2px 4px;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .session-item-menu-btn:hover {
      background: #f3f4f6;
      color: #4b5563;
    }

    .session-item-whatchanged-btn {
      font-size: 0.9rem;
    }

    .session-item-menu {
      position: absolute;
      left: 6px;
      top: 100%;
      margin-top: 4px;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      box-shadow: var(--shadow-md);
      padding: 4px;
      min-width: 140px;
      z-index: 160;
      display: none;
    }

    .session-item-menu.open {
      display: block;
    }

    .session-item-menu-item {
      width: 100%;
      text-align: right;
      border: none;
      background: transparent;
      padding: 6px 8px;
      font-size: 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      color: #111827;
    }

    .session-item-menu-item:hover {
      background: #f3f4f6;
    }

    /* Chat Area */
    .chat-panel {
      flex: 1;
      min-width: 0;
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      position: relative;
      /* height: 100%;  -- ביטול גובה נעול, כדי שלא ייחתך */
    }

    .chat-panel::before,
    .chat-panel::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      height: 18px;
      pointer-events: none;
      z-index: 5;
      opacity: 0;
      transition: opacity 0.15s ease-out;
    }

    .chat-panel::before {
      top: 0;
      background: linear-gradient(to bottom,
          rgba(243, 245, 249, 1),
          rgba(243, 245, 249, 0));
    }

    .chat-panel::after {
      bottom: 0;
      background: linear-gradient(to top,
          rgba(243, 245, 249, 1),
          rgba(243, 245, 249, 0));
    }

    .chat-panel.has-scroll-top::before {
      opacity: 1;
    }

    .chat-panel.has-scroll-bottom::after {
      opacity: 1;
    }

    /* Messages area */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .message-row {
      display: flex;
      width: 100%;
      margin-bottom: 8px;
      padding: 0 40px;
    }

    @media (min-width: 1200px) {
      #messages>.message-row {
        max-width: 900px;
        margin: 0 auto;
      }
    }

    .message-row.user {
      justify-content: flex-start;
    }

    .message-row.user .message-content {
      background: var(--bubble-user);
      color: var(--text-user);
      border-radius: 20px 4px 20px 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .message-row.assistant {
      justify-content: flex-end;
    }

    .message-row.assistant .message-content {
      background: #ffffff;
      color: var(--text-ai);
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: var(--shadow-md);
    }

    .message-content {
      max-width: 100%;
      padding: 14px 20px;
      font-size: 0.95rem;
      line-height: 1.6;
      position: relative;
      word-wrap: break-word;
    }

    .message-text {
      white-space: normal;
      word-wrap: break-word;
    }

    /* Markdown inside messages */
    .message-content p {
      margin: 0 0 6px 0;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .message-content ul,
    .message-content ol {
      margin: 6px 0 6px 1rem;
      padding: 0;
    }

    .message-content li {
      margin-bottom: 3px;
    }

    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4 {
      margin: 6px 0;
      font-weight: 700;
      line-height: 1.3;
    }

    .message-content h1 {
      font-size: 1.15rem;
    }

    .message-content h2 {
      font-size: 1.05rem;
    }

    .message-content h3 {
      font-size: 0.98rem;
    }

    .message-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 0.85rem;
      background: #f9fafb;
      border-radius: 8px;
      overflow: hidden;
    }

    .message-content th,
    .message-content td {
      border: 1px solid var(--border-subtle);
      padding: 6px 8px;
      text-align: right;
    }

    .message-content th {
      background: #eef2ff;
      font-weight: 600;
    }

    .message-content pre {
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      padding: 10px 12px;
      overflow-x: auto;
      font-size: 0.8rem;
      margin: 8px 0;
    }

    .message-content code {
      background: rgba(15, 23, 42, 0.06);
      padding: 2px 4px;
      border-radius: 4px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85em;
    }

    .message-content pre code {
      background: transparent;
      padding: 0;
    }

    .message-row.assistant .message-content a.link-bubble {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #eff6ff;
      text-decoration: none;
      margin: 0 2px;
      font-size: 0.8rem;
      color: #1d4ed8;
      position: relative;
    }

    .message-row.assistant .message-content a.link-bubble:hover {
      background: #dbeafe;
      border-color: #93c5fd;
    }

    .message-row.assistant .message-content a.link-bubble-icon {
      line-height: 1;
    }

    .message-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.75rem;
      align-items: center;
    }

    .star-btn {
      border: none;
      background: transparent;
      color: #4b5563;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 0;
      font-size: 0.8rem;
    }

    .star-btn span.icon {
      font-size: 0.9rem;
    }

    .star-btn:hover {
      color: #111827;
    }

    .message-row.user .star-btn {
      color: #e5e7eb;
    }

    .message-row.user .star-btn:hover {
      color: #f9fafb;
    }

    .star-btn.star-low {
      color: #10b981;
    }

    .star-btn.star-medium {
      color: #f59e0b;
    }

    .star-btn.star-high {
      color: #ef4444;
    }

    .highlight-picker {
      display: none;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .highlight-picker.open {
      display: flex;
    }

    .highlight-level-btn {
      border: none;
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 2px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #f3f4f6;
      color: #374151;
    }

    .highlight-level-btn.low {
      border: 1px solid #10b98133;
    }

    .highlight-level-btn.medium {
      border: 1px solid #f59e0b33;
    }

    .highlight-level-btn.high {
      border: 1px solid #ef444433;
    }

    .highlight-level-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #10b981;
    }

    .highlight-level-btn.medium .highlight-level-dot {
      background: #f59e0b;
    }

    .highlight-level-btn.high .highlight-level-dot {
      background: #ef4444;
    }

    .message-avatar {
      display: none;
    }

    .message.system {
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
      padding: 16px;
      border-radius: var(--radius-md);
      text-align: right;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 12px auto;
      max-width: 700px;
    }

    .system-hero-title {
      font-size: 1rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }

    .system-hero-sub {
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .system-hero-list {
      list-style: none;
      padding: 0;
      margin: 0 0 8px 0;
    }

    .system-hero-list li {
      margin-bottom: 4px;
    }

    .system-hero-list li::before {
      content: "• ";
    }

    .system-hero-hint {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .system-about-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .system-about-cta {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .system-about-cta a {
      color: #2563eb;
      text-decoration: none;
    }

    .system-about-cta a:hover {
      text-decoration: underline;
    }

    /* Followups */
    .followups-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .followup-chip {
      border: none;
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .followup-chip:hover {
      background: #e5e7eb;
      color: #111827;
    }

    /* ===== Highlights Panel ===== */
    .highlights-panel {
      padding: 10px 16px 12px;
      border-top: 1px solid var(--border-subtle);
      background: #f9fafb;
    }

    .highlights-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }

    .highlights-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }

    .highlights-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: left;
      flex: 1;
    }

    .highlights-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .highlights-filter-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .highlights-filter-select {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 2px 8px;
      font-size: 0.75rem;
      background: #ffffff;
      color: #374151;
      outline: none;
    }

    .highlights-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 140px;
      overflow-y: auto;
      margin-bottom: 4px;
    }

    .highlights-empty {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .highlight-item {
      position: relative;
      padding: 6px 28px 6px 10px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      font-size: 0.8rem;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    .highlight-item::before {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      border-radius: 10px 0 0 10px;
      background: #10b981;
    }

    .highlight-item.level-medium::before {
      background: #f59e0b;
    }

    .highlight-item.level-high::before {
      background: #ef4444;
    }

    .highlight-meta {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 2px;
      font-size: 0.7rem;
      color: #6b7280;
      flex-wrap: wrap;
    }

    .highlight-tag {
      font-weight: 500;
      color: #111827;
    }

    .highlight-text {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .highlight-delete-btn {
      position: absolute;
      left: 6px;
      top: 4px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 2px;
    }

    .highlight-delete-btn:hover {
      color: #ef4444;
    }

    .highlight-expand-btn {
      margin-top: 3px;
      border: none;
      background: transparent;
      padding: 0;
      font-size: 0.7rem;
      color: #2563eb;
      cursor: pointer;
    }

    .highlight-expand-btn:hover {
      text-decoration: underline;
    }

    /* Input Area */
    .input-area-wrapper {
      padding: 16px 20px 18px;
      background: linear-gradient(to top, #ffffff 80%, rgba(255, 255, 255, 0));
      z-index: 10;
    }

    .input-box-container {
      max-width: 860px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      border-radius: 24px;
      padding: 6px 8px 10px 16px;
      box-shadow: var(--shadow-float);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-box-container:focus-within {
      border-color: #9ca3af;
      box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.12);
    }

    .textarea-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    textarea {
      flex: 1;
      border: none;
      resize: none;
      background: transparent;
      max-height: 80px;
      min-height: 20px;
      height: 20px;
      font-family: inherit;
      font-size: 0.9rem;
      line-height: 1.4;
      padding: 6px 0;
      color: var(--primary);
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    .send-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.1s, background 0.2s;
      margin-bottom: 2px;
      font-size: 0.9rem;
    }

    .send-btn:disabled {
      background: #e5e7eb;
      cursor: not-allowed;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    /* תיק דמי */
    .paper-portfolio-row {
      margin-top: 6px;
      border-top: 1px dashed var(--border-subtle);
      padding-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .paper-portfolio-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .paper-portfolio-toggle {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      background: #f3f4f6;
      color: #4b5563;
      cursor: pointer;
      white-space: nowrap;
    }

    .paper-portfolio-toggle.active {
      background: #111827;
      color: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .paper-portfolio-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      flex: 1;
    }

    .paper-portfolio-body {
      display: none;
      flex-direction: column;
      gap: 6px;
      margin-top: 2px;
    }

    .paper-portfolio-body.open {
      display: flex;
    }

    .paper-portfolio-input-row {
      display: flex;
      gap: 6px;
    }

    .paper-portfolio-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #f9fafb;
      color: #111827;
    }

    .paper-portfolio-add {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #e5e7eb;
      color: #111827;
      cursor: pointer;
      white-space: nowrap;
    }

    .paper-portfolio-add:hover {
      background: #d1d5db;
    }

    .paper-portfolio-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .paper-portfolio-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.75rem;
      color: #374151;
    }

    .paper-portfolio-chip-remove {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .paper-portfolio-chip-remove:hover {
      color: #ef4444;
    }

    .paper-portfolio-empty {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .examples-container {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 860px;
      width: 100%;
      margin-inline: auto;
      justify-content: flex-start;
    }

    .example-chip {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 99px;
      padding: 6px 14px;
      font-size: 0.75rem;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .example-chip:hover {
      background: #fff;
      border-color: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .thinking-dots {
      display: inline-flex;
      gap: 4px;
      padding: 0 4px;
    }

    .thinking-dot {
      width: 6px;
      height: 6px;
      background: #9ca3af;
      border-radius: 50%;
      animation: pulse 1.4s infinite;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .thinking-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 0.4;
        transform: scale(0.8);
      }

      50% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ===== Mobile Layout Tweaks ===== */
    @media (max-width: 900px) {
      .app-shell {
        padding: 8px;
        /* לפני כן height: calc(100vh - 64px) – גורם לחיתוכים; עכשיו מינימום וגלילה חופשית */
        min-height: calc(var(--vh, 1vh) * 100 - 64px);
      }

      .app-container {
        flex-direction: column;
        /* height: 100%;  -- ביטול, כדי לא לנעול גובה */
        gap: 8px;
      }

      .sidebar {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        padding: 10px 12px;
        border-radius: 14px;
        margin-bottom: 4px;
      }

      .sidebar-mobile {
        display: flex;
      }

      .sidebar-header {
        display: none;
      }

      .session-list {
        display: none;
      }

      .chat-panel {
        border-radius: 16px;
      }

      #messages {
        padding: 12px 8px 24px;
      }

      .message-row {
        padding: 0 8px;
      }

      .message-content {
        max-width: 95%;
      }

      .highlights-panel {
        padding: 8px 10px;
      }

      .highlights-list {
        max-height: 120px;
      }
    }
  </style>
</head>

<body>
  <!-- Landing -->
  <div id="landing-overlay" class="landing-overlay">
    <div class="landing-content">
      <div class="landing-icon"></div>
      <div style="text-align:center;">
        <h1 class="landing-title">DRAFFIQ AI</h1>
        <div class="landing-subtitle">מודיעין עסקי לשוק ההון הישראלי</div>
      </div>
      <button type="button" id="landing-cta" class="landing-cta">
        <span>כניסה למערכת</span>
        <span>←</span>
      </button>
    </div>
  </div>

  <!-- Top bar -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="brand">
        <div class="brand-logo-small">DF</div>
        <div class="brand-text">
          <h1>DRAFFIQ</h1>
          <span>מודיעין עסקי לשוק ההון</span>
        </div>
      </div>

      <div class="top-actions">
        <div class="status-badge">TASE LIVE</div>
        <button id="new-btn" class="new-chat-btn-top">חדש</button>

        <!-- תפריט מחקר וכלים -->
        <div class="research-menu">
          <button id="research-btn" class="icon-btn icon-btn-settings" title="כלי מחקר">
            <svg viewBox="0 0 20 20" class="settings-icon" aria-hidden="true">
              <line x1="4" y1="6" x2="16" y2="6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
              <circle cx="9" cy="6" r="1.6" fill="currentColor" />
              <line x1="4" y1="10" x2="16" y2="10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
              <circle cx="12.5" cy="10" r="1.6" fill="currentColor" />
              <line x1="4" y1="14" x2="16" y2="14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
              <circle cx="7" cy="14" r="1.6" fill="currentColor" />
            </svg>
          </button>
          <div id="research-dropdown" class="research-dropdown">
            <div class="research-section">מצב מחקר</div>
            <div class="research-pills">
              <button type="button" class="work-mode-option active" data-mode="stock">מניות</button>
              <button type="button" class="work-mode-option" data-mode="bond">אג"ח</button>
              <button type="button" class="work-mode-option" data-mode="sector">סקטורים</button>
            </div>

            <div class="research-section">סוג נכס</div>
            <select id="asset-type" class="research-select">
              <option value="">ללא</option>
              <option value="equity">מניה</option>
              <option value="bond_gov">אג"ח ממשלתי</option>
              <option value="bond_corp">אג"ח קונצרני</option>
              <option value="fund">קרן / ETF</option>
              <option value="index">מדד</option>
            </select>

            <div class="research-section">כלים</div>
            <button type="button" class="research-item" id="deep-mode-btn">Deep Dive</button>
            <button type="button" class="research-item" id="share-btn">שתף</button>
            <button type="button" class="research-item" id="print-btn">PDF</button>
          </div>
        </div>

        <button id="menu-btn" class="icon-btn">☰</button>

        <div id="menu-dropdown" class="menu-dropdown">
          <button class="menu-item" id="home-link">
            <span>⌂</span>
            <span>מסך הבית</span>
          </button>
          <button class="menu-item" id="chat-link">
            <span>➤</span>
            <span>קפיצה לצ'אט</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Layout -->
  <div class="app-shell">
    <div class="app-container">

      <aside class="sidebar">
        <!-- מובייל: דרופ-דאון לשיחות -->
        <div class="sidebar-mobile">
          <span class="sidebar-mobile-label">שיחה פעילה</span>
          <select id="mobile-session-select" class="sidebar-mobile-select"></select>
          <button id="mobile-new-session-btn" type="button" class="sidebar-mobile-new">חדש</button>
        </div>

        <div class="sidebar-header">
          <span class="sidebar-title">היסטוריית שיחות</span>
          <div class="sidebar-header-actions">
            <button id="sidebar-new-btn" title="שיחה חדשה">+</button>
          </div>
        </div>
        <div class="session-list" id="session-list"></div>
      </aside>

      <main class="chat-panel" id="chat-section">
        <div id="messages">
          <div class="message system">
            <div class="system-hero-title">יחידת מחקר לשוק ההון הישראלי</div>
            <div class="system-hero-sub">
              כתוב שאלת מחקר כפי שהיית מנסח לאנליסט בכיר – DRAFFIQ AI ממפה עבורך סיכונים, הזדמנויות ותסריטים קדימה.
            </div>
            <ul class="system-hero-list">
              <li>ניתוח מניות, אג"ח וסקטורים עם דגש על איכות דוחות, מינוף ותזרים.</li>
              <li>מיצוב החברה מול מתחרות, מגמות סקטור ותמחור ביחס לסיכון.</li>
              <li>מיקוד בנקודות שכדאי לחפור בהן ידנית – לא החלפה של בדיקה אנושית.</li>
            </ul>
            <div class="system-hero-hint">
              ברירת המחדל היא מענה רגיל. אפשר להדליק <strong>Deep Dive</strong> לניתוח מעמיק יותר באותה שיחה.
              <br>
              מומלץ לבחור סוג נכס כדי לחדד את התשובה.
            </div>
          </div>

          <div class="message system">
            <div class="system-about-title">מי עומד מאחורי DRAFFIQ?</div>
            <div>
              המערכת נשענת על ניתוח טקסטואלי מתקדם, שילוב בין קריאת דוחות, חדשות ושיח שוק, יחד עם מתודולוגיות מחקר
              מעולמות פיננסים וניתוח התנהגותי.
              המטרה: לא "צ'אט־בוט חכם", אלא שכבת חשיבה שעוזרת לך להבין מה חשוב לקרוא ומה אפשר לדלג.
            </div>
            <div class="system-about-cta">
              רוצה לחבר את DRAFFIQ למחלקת המחקר או לקבל גישה מתקדמת (API / התאמה ספציפית)?
              ניתן לפנות לכתובת המייל: <a href="mailto:info@draffiq.com">info@draffiq.com</a>
            </div>
          </div>
        </div>

        <!-- פאנל כוכבים: ריכוז נקודות מסומנות מהשיחה -->
        <section id="highlights-panel" class="highlights-panel">
          <div class="highlights-header">
            <span class="highlights-title">נקודות שסימנת</span>
            <span id="highlights-hint" class="highlights-hint"></span>
          </div>

          <!-- פילטרים לכוכבים -->
          <div class="highlights-filters">
            <label class="highlights-filter-label">
              רמת סיכון
              <select id="highlights-filter-level" class="highlights-filter-select">
                <option value="all">הכל</option>
                <option value="low">ירוק</option>
                <option value="medium">צהוב</option>
                <option value="high">אדום</option>
              </select>
            </label>
            <label class="highlights-filter-label">
              מקור
              <select id="highlights-filter-source" class="highlights-filter-select">
                <option value="all">הכל</option>
                <option value="user">ממך</option>
                <option value="assistant">מהמערכת</option>
              </select>
            </label>
          </div>

          <div id="highlights-list" class="highlights-list"></div>
          <div id="highlights-empty" class="highlights-empty">
            עדיין לא סימנת שום דבר. בלחיצה על ⭐ ליד תשובה מעניינת – היא תרד למטה עם צבע ותווית קצרה.
          </div>
        </section>

        <div class="input-area-wrapper">
          <form id="chat-form">
            <div class="input-box-container">
              <div class="textarea-row">
                <textarea id="query" name="query" rows="1"
                  placeholder="שאל שאלה על מניה, דוח או סקטור..."></textarea>
                <button type="submit" id="send-btn" class="send-btn">➤</button>
              </div>

              <!-- מצב תיק דמי – בחירת רשימת ניירות -->
              <div class="paper-portfolio-row">
                <div class="paper-portfolio-header">
                  <button type="button" id="paper-portfolio-toggle" class="paper-portfolio-toggle">
                    תיק דמי
                  </button>
                  <span class="paper-portfolio-hint">
                    להריץ את אותה שאלה על כמה ניירות בבת אחת.
                  </span>
                </div>
                <div id="paper-portfolio-body" class="paper-portfolio-body">
                  <div class="paper-portfolio-input-row">
                    <input type="text" id="paper-portfolio-input" class="paper-portfolio-input"
                      placeholder="הקלד טיקר (למשל: TASE:XXXXX) ולחץ Enter או הוסף">
                    <button type="button" id="paper-portfolio-add" class="paper-portfolio-add">
                      הוסף
                    </button>
                  </div>
                  <div id="paper-portfolio-chips" class="paper-portfolio-chips"></div>
                </div>
              </div>
            </div>

            <div id="promptExamplesContainer" class="examples-container"></div>

            <div style="text-align:center; margin-top:10px; font-size:0.65rem; color:#9ca3af;">
              המידע אינו מהווה ייעוץ השקעות. ט.ל.ח.
            </div>
          </form>
        </div>
      </main>

    </div>
  </div>

  <script>
    const SESSIONS_KEY = "draffiq-sessions-v2";
    const OLD_STORAGE_KEY = "draffiq-chat-v1";

    const form = document.getElementById("chat-form");
    const textarea = document.getElementById("query");
    const messages = document.getElementById("messages");
    const sendBtn = document.getElementById("send-btn");
    const printBtn = document.getElementById("print-btn");
    const shareBtn = document.getElementById("share-btn");
    const newBtn = document.getElementById("new-btn");
    const menuBtn = document.getElementById("menu-btn");
    const landingOverlay = document.getElementById("landing-overlay");
    const landingCta = document.getElementById("landing-cta");
    const chatSection = document.getElementById("chat-section");
    const menuDropdown = document.getElementById("menu-dropdown");
    const homeLink = document.getElementById("home-link");
    const chatLink = document.getElementById("chat-link");
    const sessionListEl = document.getElementById("session-list");
    const sidebarNewBtn = document.getElementById("sidebar-new-btn");
    const deepModeBtn = document.getElementById("deep-mode-btn");
    const assetTypeSelect = document.getElementById("asset-type");
    const researchBtn = document.getElementById("research-btn");
    const researchDropdown = document.getElementById("research-dropdown");

    const highlightsListEl = document.getElementById("highlights-list");
    const highlightsEmptyEl = document.getElementById("highlights-empty");
    const highlightsHintEl = document.getElementById("highlights-hint");
    const highlightsFilterLevelEl = document.getElementById("highlights-filter-level");
    const highlightsFilterSourceEl = document.getElementById("highlights-filter-source");

    // מובייל – דרופ דאון לשיחה פעילה
    const mobileSessionSelect = document.getElementById("mobile-session-select");
    const mobileNewSessionBtn = document.getElementById("mobile-new-session-btn");

    // תיק דמי – אלמנטים
    const paperPortfolioToggle = document.getElementById("paper-portfolio-toggle");
    const paperPortfolioBody = document.getElementById("paper-portfolio-body");
    const paperPortfolioInput = document.getElementById("paper-portfolio-input");
    const paperPortfolioAddBtn = document.getElementById("paper-portfolio-add");
    const paperPortfolioChipsEl = document.getElementById("paper-portfolio-chips");

    let sessions = [];
    let activeSessionId = null;
    let currentMode = "normal";
    let currentWorkMode = "stock";

    let interactionCount = 0;

    let paperPortfolioEnabled = false;
    let paperPortfolioTickers = [];

    let highlightFilterLevel = "all";
    let highlightFilterSource = "all";

    const HIGHLIGHT_HINT_MESSAGES = [
      "טיפ: אפשר לסמן תשובה מעניינת ב-⭐ והיא תרד למטה עם צבע ותווית קצרה.",
      "כוכבים יוצרים לך מיני-ארכיון של נקודות חשובות בשיחה הזו.",
      "יש חלק שהיית רוצה לחזור אליו לקראת החלטה? סימון ב-⭐ משאיר אותו בקובייה למטה."
    ];
    let lastHintIndex = -1;

    const EXAMPLE_PROMPTS = [
      {
        label: "סביבת ריבית גבוהה",
        text: "נתח את ההשפעה של סביבת ריבית גבוהה על ______ בשנתיים הקרובות, כולל סיכונים והזדמנויות מרכזיים."
      },
      {
        label: "אינפלציה וצמיחה",
        text: "איך שילוב של אינפלציה גבוהה וצמיחה נמוכה עשוי להשפיע על ______ מבחינת תמחור, רווחיות ומינוף?"
      },
      {
        label: "רגולציה חדשה",
        text: "אילו תרחישים רגולטוריים סביב ______ יכולים להיות Game Changer, ומה המשמעות של כל תרחיש למשקיעים?"
      },
      {
        label: "גיאופוליטיקה",
        text: "כיצד סיכונים גיאופוליטיים הקשורים ל ______ עשויים להשפיע על תמחור, נזילות ויכולת גיוס הון?"
      }
    ];

    // עדכון משתנה --vh לגובה אמיתי של viewport (בעיקר למובייל)
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty("--vh", vh + "px");
    }
    window.addEventListener("load", setViewportHeight);
    window.addEventListener("resize", setViewportHeight);

    function autoResizeTextarea(el) {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 80) + 'px';
    }

    if (textarea) {
      textarea.addEventListener("input", () => autoResizeTextarea(textarea));
      textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (form) form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
        }
      });
    }

    function updateScrollShadows() {
      if (!messages || !chatSection) return;
      const { scrollTop, scrollHeight, clientHeight } = messages;

      if (scrollTop > 0) {
        chatSection.classList.add("has-scroll-top");
      } else {
        chatSection.classList.remove("has-scroll-top");
      }

      if (scrollTop + clientHeight < scrollHeight - 1) {
        chatSection.classList.add("has-scroll-bottom");
      } else {
        chatSection.classList.remove("has-scroll-bottom");
      }
    }

    // Markdown renderer
    function renderMarkdownToHtml(text) {
      if (!text) return "";
      try {
        if (window.marked) {
          marked.setOptions({
            gfm: true,
            breaks: true
          });
          const rawHtml = marked.parse(text);
          if (window.DOMPurify) {
            return DOMPurify.sanitize(rawHtml);
          }
          return rawHtml;
        }
      } catch (e) {
        // fallback below
      }

      // Fallback פשוט – בלי markdown מלא
      const escaped = String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

      return escaped.replace(/\n/g, "<br>");
    }

    function saveSessions() {
      try {
        localStorage.setItem(SESSIONS_KEY, JSON.stringify({ sessions, activeSessionId }));
      } catch (e) { }
    }

    function getActiveSession() {
      return sessions.find((s) => s.id === activeSessionId) || null;
    }

    function getHighlightsForActiveSession() {
      const session = getActiveSession();
      if (!session) return [];
      if (!Array.isArray(session.highlights)) {
        session.highlights = [];
      }
      return session.highlights;
    }

    function getHighlightLevelLabel(level) {
      switch (level) {
        case "high":
          return "אדום – קריטי / סיכון";
        case "medium":
          return "צהוב – לשים לב";
        default:
          return "ירוק – מעניין / נמוך סיכון";
      }
    }

    function buildHighlightPreview(text) {
      if (!text) return "";
      let clean = text.replace(/\s+/g, " ").trim();
      if (clean.length > 180) {
        clean = clean.slice(0, 180) + "…";
      }
      return clean;
    }

    function addHighlight(text, role, level, tag) {
      const session = getActiveSession();
      if (!session) return;
      if (!Array.isArray(session.highlights)) {
        session.highlights = [];
      }

      const id = "h_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      session.highlights.push({
        id,
        text,
        role,
        level: level || "low",
        tag: tag || "",
        createdAt: Date.now()
      });

      saveSessions();
      renderHighlights();
      updateHighlightsHint(true);
    }

    function removeHighlight(id) {
      const session = getActiveSession();
      if (!session || !Array.isArray(session.highlights)) return;
      session.highlights = session.highlights.filter(h => h.id !== id);
      saveSessions();
      renderHighlights();
      updateHighlightsHint(true);
    }

    function renderHighlights() {
      if (!highlightsListEl || !highlightsEmptyEl) return;

      const highlights = getHighlightsForActiveSession();
      highlightsListEl.innerHTML = "";

      if (!highlights.length) {
        highlightsEmptyEl.textContent = "עדיין לא סימנת שום דבר. בלחיצה על ⭐ ליד תשובה מעניינת – היא תרד לכאן עם צבע ותווית קצרה.";
        highlightsEmptyEl.style.display = "block";
        return;
      }

      const filtered = highlights.filter(h => {
        const lvl = h.level || "low";
        if (highlightFilterLevel !== "all" && lvl !== highlightFilterLevel) return false;
        if (highlightFilterSource !== "all" && h.role !== highlightFilterSource) return false;
        return true;
      });

      if (!filtered.length) {
        highlightsEmptyEl.textContent = "אין נקודות שמתאימות למסנן הנוכחי.";
        highlightsEmptyEl.style.display = "block";
        return;
      }

      highlightsEmptyEl.style.display = "none";

      filtered.forEach((h) => {
        const item = document.createElement("div");
        item.className = "highlight-item level-" + (h.level || "low");
        item.dataset.expanded = "false";

        const meta = document.createElement("div");
        meta.className = "highlight-meta";

        if (h.tag) {
          const tagSpan = document.createElement("span");
          tagSpan.className = "highlight-tag";
          tagSpan.textContent = h.tag;
          meta.appendChild(tagSpan);
          meta.appendChild(document.createTextNode(" · "));
        }

        const levelSpan = document.createElement("span");
        levelSpan.textContent = getHighlightLevelLabel(h.level);

        const sourceSpan = document.createElement("span");
        sourceSpan.textContent = h.role === "user" ? "ממך" : "מהמערכת";

        meta.appendChild(levelSpan);
        meta.appendChild(document.createTextNode(" · "));
        meta.appendChild(sourceSpan);

        const textDiv = document.createElement("div");
        textDiv.className = "highlight-text";
        textDiv.textContent = buildHighlightPreview(h.text);
        textDiv.title = h.text;

        const expandBtn = document.createElement("button");
        expandBtn.type = "button";
        expandBtn.className = "highlight-expand-btn";
        expandBtn.textContent = "פתיחה";

        expandBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const expanded = item.dataset.expanded === "true";
          if (expanded) {
            item.dataset.expanded = "false";
            textDiv.textContent = buildHighlightPreview(h.text);
            expandBtn.textContent = "פתיחה";
          } else {
            item.dataset.expanded = "true";
            textDiv.textContent = h.text;
            expandBtn.textContent = "סגירה";
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "highlight-delete-btn";
        deleteBtn.innerHTML = "✕";
        deleteBtn.title = "הסרת הנקודה מהרשימה";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          removeHighlight(h.id);
        });

        item.appendChild(meta);
        item.appendChild(textDiv);
        item.appendChild(expandBtn);
        item.appendChild(deleteBtn);
        highlightsListEl.appendChild(item);
      });
    }

    function updateHighlightsHint(force = false) {
      if (!highlightsHintEl) return;
      const highlights = getHighlightsForActiveSession();

      if (highlights.length > 0) {
        highlightsHintEl.textContent = "כאן מרוכזות הנקודות שסימנת לאורך השיחה – אפשר לחזור אליהן גם בעוד כמה שעות.";
        return;
      }

      if (force || interactionCount % 3 === 0 || lastHintIndex === -1) {
        lastHintIndex = (lastHintIndex + 1) % HIGHLIGHT_HINT_MESSAGES.length;
        highlightsHintEl.textContent = HIGHLIGHT_HINT_MESSAGES[lastHintIndex];
      }
    }

    function attachStarControlsToMessage(contentEl, text, role) {
      if (!contentEl) return;

      const actions = document.createElement("div");
      actions.className = "message-actions";

      const starBtn = document.createElement("button");
      starBtn.type = "button";
      starBtn.className = "star-btn";
      starBtn.title = "סימון הנקודה הזו למעקב בקובייה למטה";

      const starIconSpan = document.createElement("span");
      starIconSpan.className = "icon";
      starIconSpan.textContent = "⭐";

      const starTextSpan = document.createElement("span");
      starTextSpan.textContent = "סימון";

      starBtn.appendChild(starIconSpan);
      starBtn.appendChild(starTextSpan);

      const picker = document.createElement("div");
      picker.className = "highlight-picker";

      const levels = [
        { key: "low", label: "ירוק – מעניין / נמוך סיכון" },
        { key: "medium", label: "צהוב – לשים לב" },
        { key: "high", label: "אדום – קריטי / סיכון" }
      ];

      levels.forEach((lvl) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "highlight-level-btn " + lvl.key;

        const dot = document.createElement("span");
        dot.className = "highlight-level-dot";

        const labelSpan = document.createElement("span");
        labelSpan.textContent = lvl.label;

        btn.appendChild(dot);
        btn.appendChild(labelSpan);

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const rawTag = window.prompt("תווית קצרה לנקודה הזו (לא חובה):", "");
          const tag = rawTag && rawTag.trim() ? rawTag.trim() : "";

          addHighlight(text, role, lvl.key, tag);
          picker.classList.remove("open");

          starBtn.classList.remove("star-low", "star-medium", "star-high");
          starBtn.classList.add("star-" + lvl.key);
          starTextSpan.textContent = "מסומן";
        });

        picker.appendChild(btn);
      });

      starBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isOpen = picker.classList.contains("open");

        document.querySelectorAll(".highlight-picker.open").forEach(p => p.classList.remove("open"));

        if (!isOpen) {
          picker.classList.add("open");
        }
      });

      actions.appendChild(starBtn);
      actions.appendChild(picker);
      contentEl.appendChild(actions);
    }

    function generateFollowupSuggestions(answerText) {
      const suggestions = [];
      const text = (answerText || "").toString();

      if (currentWorkMode === "stock") {
        suggestions.push("השווה את החברה למתחרות המרכזיות בבורסה מבחינת צמיחה, רווחיות ומינוף.");
      } else if (currentWorkMode === "bond") {
        suggestions.push("נתח את פרופיל הסיכון של האג\"ח ביחס לאג\"ח חלופיות דומות בשוק.");
      } else if (currentWorkMode === "sector") {
        suggestions.push("שווה את הסקטור הזה לסקטורים קרובים מבחינת צמיחה, רווחיות וסיכון רגולטורי.");
      }

      if (/סיכון|סיכונים/.test(text)) {
        suggestions.push("תפרט את הסיכונים המרכזיים שהיית שם בראש סדר העדיפויות למשקיע.");
      }

      if (/תזרים|מזומנים/.test(text)) {
        suggestions.push("העמק בתזרים המזומנים: מה עלול להשתבש בתרחיש שמרני יותר?");
      }

      suggestions.push("מה היית בודק ידנית בדוחות / מצגות לפני החלטה בפועל?");

      const unique = Array.from(new Set(suggestions));
      return unique.slice(0, 3);
    }

    function attachFollowupSuggestions(contentEl, answerText) {
      if (!contentEl) return;
      const suggestions = generateFollowupSuggestions(answerText);
      if (!suggestions.length) return;

      const row = document.createElement("div");
      row.className = "followups-row";

      suggestions.forEach((q) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "followup-chip";
        btn.textContent = q;
        btn.addEventListener("click", () => {
          if (!textarea) return;
          textarea.value = q;
          autoResizeTextarea(textarea);
          textarea.focus();
        });
        row.appendChild(btn);
      });

      contentEl.appendChild(row);
    }

    function renderMessagesForSession(session, options = {}) {
      const { scroll = true } = options;
      if (!messages) return;

      const rows = messages.querySelectorAll(".message-row");
      rows.forEach(r => r.remove());

      if (!session || !Array.isArray(session.messages)) {
        if (scroll) {
          messages.scrollTop = 0;
          updateScrollShadows();
        }
        return;
      }

      session.messages.forEach(m =>
        appendMessage(m.text, m.role, { persist: false, scroll: false })
      );

      if (scroll) {
        messages.scrollTop = messages.scrollHeight;
      }

      updateScrollShadows();
      renderHighlights();
      updateHighlightsHint(true);
    }

    function renderMobileSessionSelect() {
      if (!mobileSessionSelect) return;
      mobileSessionSelect.innerHTML = "";

      sessions.forEach(sess => {
        const opt = document.createElement("option");
        opt.value = sess.id;
        opt.textContent = sess.title ||
          ("שיחה " + new Date(sess.createdAt).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }));
        mobileSessionSelect.appendChild(opt);
      });

      if (activeSessionId) {
        mobileSessionSelect.value = activeSessionId;
      }
    }

    function renderSessionList() {
      if (!sessionListEl) return;
      sessionListEl.innerHTML = "";

      sessions.forEach(sess => {
        const wrapper = document.createElement("div");
        wrapper.className = "session-item-wrapper" + (sess.id === activeSessionId ? " active" : "");
        wrapper.dataset.sessionId = sess.id;

        const mainBtn = document.createElement("button");
        mainBtn.type = "button";
        mainBtn.className = "session-item-main";
        mainBtn.textContent = sess.title ||
          ("שיחה " + new Date(sess.createdAt).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }));
        mainBtn.title = "פתיחת שיחה";

        mainBtn.addEventListener("click", () => {
          if (sess.id === activeSessionId) return;
          activeSessionId = sess.id;
          saveSessions();
          renderSessionList();
          renderMobileSessionSelect();
          renderMessagesForSession(sess);
        });

        const whatChangedBtn = document.createElement("button");
        whatChangedBtn.type = "button";
        whatChangedBtn.className = "session-item-menu-btn session-item-whatchanged-btn";
        whatChangedBtn.innerHTML = "⟲";
        whatChangedBtn.title = "עדכן את הניתוח הזה לפי מה שקרה מאז התשובה הקודמת";

        whatChangedBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          triggerWhatChangedForSession(sess.id);
        });

        const menuBtnSession = document.createElement("button");
        menuBtnSession.type = "button";
        menuBtnSession.className = "session-item-menu-btn";
        menuBtnSession.innerHTML = "⋮";

        const menu = document.createElement("div");
        menu.className = "session-item-menu";

        const renameItem = document.createElement("button");
        renameItem.type = "button";
        renameItem.className = "session-item-menu-item";
        renameItem.textContent = "שנה שם שיחה";

        renameItem.addEventListener("click", (e) => {
          e.stopPropagation();
          menu.classList.remove("open");
          const currentTitle = sess.title || "";
          const newTitle = prompt("שם חדש לשיחה:", currentTitle);
          if (newTitle && newTitle.trim()) {
            sess.title = newTitle.trim();
            saveSessions();
            renderSessionList();
            renderMobileSessionSelect();
          }
        });

        menu.appendChild(renameItem);

        menuBtnSession.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains("open");
          document.querySelectorAll(".session-item-menu.open").forEach(m => m.classList.remove("open"));
          if (!isOpen) {
            menu.classList.add("open");
          }
        });

        wrapper.appendChild(mainBtn);
        wrapper.appendChild(whatChangedBtn);
        wrapper.appendChild(menuBtnSession);
        wrapper.appendChild(menu);

        sessionListEl.appendChild(wrapper);
      });

      renderMobileSessionSelect();
    }

    function createNewSession() {
      const id = "s_" + Date.now();
      const session = { id, title: "שיחה חדשה", createdAt: Date.now(), messages: [], highlights: [] };
      sessions.unshift(session);
      activeSessionId = id;
      saveSessions();
      renderSessionList();
      renderMessagesForSession(session);
      renderHighlights();
      updateHighlightsHint(true);
      if (textarea) {
        textarea.value = "";
        autoResizeTextarea(textarea);
        textarea.focus();
      }
    }

    function migrateOldHistoryIfNeeded() {
      try {
        const raw = localStorage.getItem(OLD_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || !parsed.length) return;
        const id = "s_" + Date.now();
        sessions = [{
          id,
          title: "שיחה קודמת",
          createdAt: Date.now(),
          messages: parsed,
          highlights: []
        }];
        activeSessionId = id;
      } catch (e) { }
    }

    function loadSessions() {
      try {
        const raw = localStorage.getItem(SESSIONS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && Array.isArray(parsed.sessions)) {
            sessions = parsed.sessions;

            sessions.forEach(s => {
              if (!Array.isArray(s.highlights)) {
                s.highlights = [];
              }
            });

            activeSessionId = parsed.activeSessionId || (sessions[0] && sessions[0].id) || null;
          }
        }
        if (!sessions || !sessions.length) {
          migrateOldHistoryIfNeeded();
        }
        if (!sessions || !sessions.length) {
          const id = "s_" + Date.now();
          sessions = [{
            id,
            title: "שיחה חדשה",
            createdAt: Date.now(),
            messages: [],
            highlights: []
          }];
          activeSessionId = id;
        }
      } catch (e) {
        const id = "s_" + Date.now();
        sessions = [{
          id,
          title: "שיחה חדשה",
          createdAt: Date.now(),
          messages: [],
          highlights: []
        }];
        activeSessionId = id;
      }
    }

    function appendMessage(text, role, options = {}) {
      const { persist = true, scroll = true } = options;
      if (!messages) return;

      const row = document.createElement("div");
      row.className = "message-row " + role;

      const content = document.createElement("div");
      content.className = "message-content";

      const textEl = document.createElement("div");
      textEl.className = "message-text";

      const html = renderMarkdownToHtml(text);
      textEl.innerHTML = html;

      content.appendChild(textEl);
      row.appendChild(content);
      messages.appendChild(row);

      if (role === "assistant") {
        const anchors = content.querySelectorAll("a[href]");
        anchors.forEach(a => {
          a.classList.add("link-bubble");
          const href = a.getAttribute("href") || "";
          a.setAttribute("title", href);
          a.innerHTML = "";
          const iconSpan = document.createElement("span");
          iconSpan.className = "link-bubble-icon";
          iconSpan.textContent = "🔗";
          a.appendChild(iconSpan);
        });
      }

      attachStarControlsToMessage(content, text, role);

      if (role === "assistant") {
        attachFollowupSuggestions(content, text);
      }

      if (scroll) {
        messages.scrollTop = messages.scrollHeight;
      }

      updateScrollShadows();

      if (persist) {
        const session = getActiveSession();
        if (session) {
          if (role === "user" && Array.isArray(session.messages) && session.messages.length === 0) {
            let t = text.replace(/\s+/g, " ").trim();
            if (t.length > 28) t = t.slice(0, 28) + "…";
            session.title = t || "שיחה חדשה";
            renderSessionList();
          }
          if (!Array.isArray(session.messages)) session.messages = [];
          session.messages.push({ role, text });
          saveSessions();
        }
      }
    }

    function appendThinking() {
      const row = document.createElement("div");
      row.className = "message-row assistant";
      const content = document.createElement("div");
      content.className = "message-content";
      content.innerHTML =
        '<div class="thinking-dots">' +
        '<span class="thinking-dot"></span>' +
        '<span class="thinking-dot"></span>' +
        '<span class="thinking-dot"></span>' +
        '</div>';
      row.appendChild(content);
      messages.appendChild(row);
      messages.scrollTop = messages.scrollHeight;
      updateScrollShadows();
      return row;
    }

    async function callApi(query) {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      if (!response.ok) {
        let err;
        try {
          err = await response.json();
        } catch {
          err = {};
        }
        throw new Error(err.error || "שגיאה בצד השרת.");
      }
      const data = await response.json();
      if (!data.ok && data.answer === undefined) {
        throw new Error(data.error || "שגיאה בצד השרת.");
      }
      return data.answer ?? "";
    }

    function getConversationPlainText() {
      const session = getActiveSession();
      if (session && Array.isArray(session.messages) && session.messages.length > 0) {
        return session.messages
          .map((m) => (m.role === "user" ? "YOU" : "DRAFFIQ") + ":\n" + m.text)
          .join("\n\n");
      }
      const rows = messages.querySelectorAll(".message-row");
      const parts = [];
      rows.forEach((row) => {
        const isUser = row.classList.contains("user");
        const label = isUser ? "YOU" : "DRAFFIQ";

        const contentEl = row.querySelector(".message-text") || row.querySelector(".message-content");
        if (!contentEl) return;
        const text = contentEl.innerText.trim();
        if (!text) return;
        parts.push(label + ":\n" + text);
      });
      return parts.join("\n\n");
    }

    if (printBtn) {
      printBtn.addEventListener("click", () => {
        window.print();
      });
    }

    if (shareBtn) {
      shareBtn.addEventListener("click", async () => {
        const text = getConversationPlainText() || "DRAFFIQ – שיחה ריקה.";
        const title = "DRAFFIQ – שיחת מחקר";
        const url = window.location.href;
        if (navigator.share) {
          try {
            await navigator.share({ title, text, url });
          } catch (e) { }
        } else {
          try {
            await navigator.clipboard.writeText(text + "\n\n" + url);
            alert("הטקסט והקישור הועתקו ללוח. ניתן להדביק בכל אפליקציה.");
          } catch {
            alert("שיתוף אוטומטי לא נתמך בדפדפן זה. נסה להעתיק ידנית.");
          }
        }
      });
    }

    if (landingCta) {
      landingCta.addEventListener("click", () => {
        landingOverlay.classList.add("hidden");
        if (chatSection && chatSection.scrollIntoView) {
          chatSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    }

    function handleNewChatClick() {
      createNewSession();
      if (menuDropdown) menuDropdown.classList.remove("open");
    }

    if (newBtn) newBtn.addEventListener("click", handleNewChatClick);
    if (sidebarNewBtn) sidebarNewBtn.addEventListener("click", handleNewChatClick);
    if (mobileNewSessionBtn) mobileNewSessionBtn.addEventListener("click", handleNewChatClick);

    if (menuBtn) {
      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (!menuDropdown) return;
        menuDropdown.classList.toggle("open");
      });
    }

    if (homeLink) {
      homeLink.addEventListener("click", () => {
        window.location.href = "/";
      });
    }

    if (chatLink) {
      chatLink.addEventListener("click", () => {
        if (chatSection && chatSection.scrollIntoView) {
          chatSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
        if (menuDropdown) menuDropdown.classList.remove("open");
      });
    }

        if (researchBtn && researchDropdown) {
      researchBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        researchDropdown.classList.toggle("open");
      });
    }

    document.addEventListener("click", (e) => {
      const target = e.target;

      if (menuDropdown && menuDropdown.classList.contains("open")) {
        if (target !== menuBtn && !(menuBtn && menuBtn.contains(target)) && !menuDropdown.contains(target)) {
          menuDropdown.classList.remove("open");
        }
      }

      if (researchDropdown && researchDropdown.classList.contains("open")) {
        if (!target.closest(".research-menu")) {
          researchDropdown.classList.remove("open");
        }
      }

      if (!target.closest(".session-item-wrapper")) {
        document.querySelectorAll(".session-item-menu.open").forEach(m => m.classList.remove("open"));
      }

      if (!target.closest(".message-actions")) {
        document.querySelectorAll(".highlight-picker.open").forEach(p => p.classList.remove("open"));
      }
    });

    if (mobileSessionSelect) {
      mobileSessionSelect.addEventListener("change", () => {
        const newId = mobileSessionSelect.value;
        if (!newId || newId === activeSessionId) return;
        activeSessionId = newId;
        saveSessions();
        renderSessionList();
        const sess = getActiveSession();
        renderMessagesForSession(sess);
      });
    }

    function renderPromptExamples() {
      const container = document.getElementById("promptExamplesContainer");
      if (!container || !textarea) return;
      container.innerHTML = EXAMPLE_PROMPTS.map((ex, i) =>
        `<button type="button" class="example-chip" data-idx="${i}">${ex.label}</button>`
      ).join("");

      container.addEventListener("click", (e) => {
        const btn = e.target.closest(".example-chip");
        if (!btn) return;
        const idx = btn.getAttribute("data-idx");
        const ex = EXAMPLE_PROMPTS[idx];
        if (!ex) return;
        textarea.value = ex.text;
        autoResizeTextarea(textarea);
        textarea.focus();
      });
    }

    function setupModeToggle() {
      if (!deepModeBtn) return;
      deepModeBtn.addEventListener("click", () => {
        const isActive = deepModeBtn.classList.contains("active");
        if (isActive) {
          deepModeBtn.classList.remove("active");
          currentMode = "normal";
        } else {
          deepModeBtn.classList.add("active");
          currentMode = "deep";
        }
      });
    }

    function setupWorkModes() {
      const buttons = document.querySelectorAll(".work-mode-option");
      if (!buttons.length) return;
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const mode = btn.getAttribute("data-mode");
          currentWorkMode = mode || "stock";
        });
      });
    }

    function normalizeTicker(value) {
      return (value || "").trim().toUpperCase().replace(/\s+/g, "");
    }

    function renderPaperPortfolioChips() {
      if (!paperPortfolioChipsEl) return;
      if (!paperPortfolioTickers.length) {
        paperPortfolioChipsEl.innerHTML = '<span class="paper-portfolio-empty">לא נבחרו עדיין ניירות.</span>';
        return;
      }
      paperPortfolioChipsEl.innerHTML = paperPortfolioTickers
        .map(ticker =>
          `<div class="paper-portfolio-chip" data-ticker="${ticker}">
             <span>${ticker}</span>
             <button type="button" class="paper-portfolio-chip-remove" title="הסרה">✕</button>
           </div>`
        )
        .join("");
    }

    function setupPaperPortfolioControls() {
      if (!paperPortfolioToggle || !paperPortfolioBody || !paperPortfolioInput || !paperPortfolioChipsEl) return;

      paperPortfolioToggle.addEventListener("click", () => {
        paperPortfolioEnabled = !paperPortfolioEnabled;
        if (paperPortfolioEnabled) {
          paperPortfolioToggle.classList.add("active");
          paperPortfolioBody.classList.add("open");
          paperPortfolioInput.focus();
        } else {
          paperPortfolioToggle.classList.remove("active");
          paperPortfolioBody.classList.remove("open");
        }
      });

      function addTickerFromInput() {
        const raw = paperPortfolioInput.value;
        const ticker = normalizeTicker(raw);
        if (!ticker) return;
        if (!paperPortfolioTickers.includes(ticker)) {
          paperPortfolioTickers.push(ticker);
          renderPaperPortfolioChips();
        }
        paperPortfolioInput.value = "";
      }

      if (paperPortfolioAddBtn) {
        paperPortfolioAddBtn.addEventListener("click", addTickerFromInput);
      }

      paperPortfolioInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addTickerFromInput();
        }
      });

      paperPortfolioChipsEl.addEventListener("click", (e) => {
        const removeBtn = e.target.closest(".paper-portfolio-chip-remove");
        if (!removeBtn) return;
        const chip = removeBtn.closest(".paper-portfolio-chip");
        if (!chip) return;
        const ticker = chip.getAttribute("data-ticker");
        paperPortfolioTickers = paperPortfolioTickers.filter(t => t !== ticker);
        renderPaperPortfolioChips();
      });

      renderPaperPortfolioChips();
    }

    async function triggerWhatChangedForSession(sessionId) {
      const session = sessions.find(s => s.id === sessionId);
      if (!session) return;

      activeSessionId = sessionId;
      saveSessions();
      renderSessionList();
      renderMessagesForSession(session);

      if (!session.messages || !session.messages.length) {
        alert("אין עדיין תוכן בשיחה הזו לעדכן.");
        return;
      }

      const userLabel = "עדכן את הניתוח הזה לפי מה שקרה מאז התשובה הקודמת.";
      appendMessage(userLabel, "user");

      interactionCount++;
      updateHighlightsHint(false);

      const historyText = session.messages
        .map(m => (m.role === "user" ? "USER" : "ASSISTANT") + ":\n" + m.text)
        .join("\n\n");

      const metaParts = [];
      if (currentWorkMode) metaParts.push(`WORK_MODE=${currentWorkMode}`);
      if (assetTypeSelect && assetTypeSelect.value) metaParts.push(`ASSET_TYPE=${assetTypeSelect.value}`);
      if (paperPortfolioEnabled && paperPortfolioTickers.length > 0) {
        metaParts.push(`PAPER_PORTFOLIO=${paperPortfolioTickers.join(",")}`);
      }
      metaParts.push("WHAT_CHANGED=1");

      const metaPrefix = metaParts.length ? "[" + metaParts.join("; ") + "] " : "";

      const queryForApi =
        metaPrefix +
        "WHAT_CHANGED_SINCE_LAST_ANSWER:\n\n" +
        "CONTEXT (FULL_CONVERSATION_HISTORY):\n" +
        historyText;

      if (sendBtn) sendBtn.disabled = true;
      const thinking = appendThinking();

      try {
        const ans = await callApi(queryForApi);
        thinking.remove();
        const safeAnswer = ans || "לא התקבלה תשובה מהשרת.";
        appendMessage(safeAnswer, "assistant");
      } catch (err) {
        thinking.remove();
        appendMessage("שגיאה בתקשורת עם השרת: " + (err.message || "שגיאה לא ידועה."), "assistant");
      } finally {
        if (sendBtn) sendBtn.disabled = false;
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      setViewportHeight();

      loadSessions();
      renderSessionList();
      renderMessagesForSession(getActiveSession(), { scroll: false });

      renderPromptExamples();
      setupModeToggle();
      setupWorkModes();
      setupPaperPortfolioControls();

      renderHighlights();
      updateHighlightsHint(true);

      if (messages) {
        messages.addEventListener("scroll", updateScrollShadows);
        updateScrollShadows();
      }

      if (highlightsFilterLevelEl) {
        highlightsFilterLevelEl.addEventListener("change", () => {
          highlightFilterLevel = highlightsFilterLevelEl.value || "all";
          renderHighlights();
        });
      }

      if (highlightsFilterSourceEl) {
        highlightsFilterSourceEl.addEventListener("change", () => {
          highlightFilterSource = highlightsFilterSourceEl.value || "all";
          renderHighlights();
        });
      }
    });

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const raw = textarea ? textarea.value.trim() : "";
        if (!raw) return;

        appendMessage(raw, "user");

        interactionCount++;
        updateHighlightsHint(false);

        const metaParts = [];
        if (currentWorkMode) {
          metaParts.push(`WORK_MODE=${currentWorkMode}`);
        }
        if (assetTypeSelect && assetTypeSelect.value) {
          metaParts.push(`ASSET_TYPE=${assetTypeSelect.value}`);
        }
        if (paperPortfolioEnabled && paperPortfolioTickers.length > 0) {
          metaParts.push(`PAPER_PORTFOLIO=${paperPortfolioTickers.join(",")}`);
        }

        const modeMarker = currentMode === "deep" ? "DEEP_DIVE" : "NORMAL";
        metaParts.push(`MODE=${modeMarker}`);

        const metaPrefix = metaParts.length ? "[" + metaParts.join("; ") + "] " : "";

        const queryForApi = metaPrefix + raw;

        if (textarea) {
          textarea.value = "";
          autoResizeTextarea(textarea);
          textarea.focus();
        }

        if (sendBtn) sendBtn.disabled = true;
        const thinking = appendThinking();

        try {
          const ans = await callApi(queryForApi);
          thinking.remove();

          const safeAnswer = ans || "לא התקבלה תשובה מהשרת.";
          appendMessage(safeAnswer, "assistant");
        } catch (err) {
          thinking.remove();
          appendMessage("שגיאה בתקשורת עם השרת: " + (err.message || "שגיאה לא ידועה."), "assistant");
        } finally {
          if (sendBtn) sendBtn.disabled = false;
        }
      });
    }
  </script>
</body>

</html>
